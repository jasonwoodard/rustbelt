<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust Belt Bandit Planner</title>
    <style>
    :root {
      --stone-50: #fafaf9;
      --stone-100: #f5f5f4;
      --stone-200: #e7e5e4;
      --stone-300: #d6d3d1;
      --stone-500: #78716c;
      --stone-600: #57534e;
      --stone-700: #44403c;
      --stone-800: #292524;
      --stone-900: #1c1917;
      --teal-50: #f0fdfa;
      --teal-100: #ccfbf1;
      --teal-600: #0d9488;
      --teal-700: #0f766e;
      --teal-800: #115e59;
      --teal-900: #134e4a;
      --blue-50: #eff6ff;
      --blue-700: #1d4ed8;
      --blue-800: #1e40af;
      --emerald-50: #ecfdf5;
      --emerald-700: #047857;
      --emerald-800: #065f46;
      --rose-600: #e11d48;
      --rose-700: #be123c;
      --ring-default: rgba(20, 184, 166, 0.45);
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--stone-100);
      color: var(--stone-800);
      line-height: 1.5;
    }
    h1,
    h2,
    h3 {
      margin: 0;
      font-weight: 600;
      color: var(--stone-900);
    }
    p {
      margin: 0;
    }
    
    .store-link {
      color: inherit;
      text-decoration: none;
    }
    
    .store-link:hover {
      text-decoration: underline;
    }
    
    .store-link:focus-visible {
      outline: 2px solid var(--teal-600);
      outline-offset: 2px;
      border-radius: 0.25rem;
    }
    
    .drop-store-button {
      background: none;
      border: none;
      padding: 0;
      font-size: 0.75rem;
      line-height: 1rem;
      color: var(--stone-500);
      cursor: pointer;
      text-decoration: underline;
      text-decoration-style: dotted;
    }
    
    .drop-store-button:hover {
      color: var(--rose-600);
    }
    
    .drop-store-button:focus-visible {
      outline: 2px solid rgba(225, 29, 72, 0.45);
      outline-offset: 2px;
      border-radius: 0.25rem;
    }
    button,
    input,
    select {
      font: inherit;
      color: inherit;
    }
    button {
      border: none;
    }
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--teal-600);
      outline-offset: 2px;
    }
    .focus\:ring-teal-500:focus-visible {
      outline: 2px solid rgba(20, 184, 166, 0.75);
      outline-offset: 2px;
    }
    .container {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      padding-left: 1rem;
      padding-right: 1rem;
      max-width: 100%;
    }
    @media (min-width: 640px) {
      .container {
        max-width: 640px;
      }
    }
    @media (min-width: 768px) {
      .container {
        max-width: 768px;
      }
      .md\:p-6 {
        padding: 1.5rem;
      }
    }
    @media (min-width: 1024px) {
      .container {
        max-width: 1024px;
      }
      .lg\:grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .lg\:col-span-1 {
        grid-column: span 1 / span 1;
      }
      .lg\:p-8 {
        padding: 2rem;
      }
    }
    @media (min-width: 1280px) {
      .container {
        max-width: 1280px;
      }
    }
    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }
    .mt-1 {
      margin-top: 0.25rem;
    }
    .mt-2 {
      margin-top: 0.5rem;
    }
    .mt-4 {
      margin-top: 1rem;
    }
    .mb-1 {
      margin-bottom: 0.25rem;
    }
    .mb-2 {
      margin-bottom: 0.5rem;
    }
    .mb-3 {
      margin-bottom: 0.75rem;
    }
    .mb-6 {
      margin-bottom: 1.5rem;
    }
    .ml-1 {
      margin-left: 0.25rem;
    }
    .ml-2 {
      margin-left: 0.5rem;
    }
    .ml-3 {
      margin-left: 0.75rem;
    }
    .pt-3 {
      padding-top: 0.75rem;
    }
    .p-2 {
      padding: 0.5rem;
    }
    .p-3 {
      padding: 0.75rem;
    }
    .p-4 {
      padding: 1rem;
    }
    .px-2 {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .px-4 {
      padding-left: 1rem;
      padding-right: 1rem;
    }
    .py-1 {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    .py-2 {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .gap-2 {
      gap: 0.5rem;
    }
    .gap-3 {
      gap: 0.75rem;
    }
    .gap-4 {
      gap: 1rem;
    }
    .gap-6 {
      gap: 1.5rem;
    }
    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }
    .space-y-3 > * + * {
      margin-top: 0.75rem;
    }
    .space-x-0 > * + * {
      margin-left: 0;
    }
    .grid {
      display: grid;
    }
    .grid-cols-1 {
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .col-span-2 {
      grid-column: span 2 / span 2;
    }
    .flex {
      display: flex;
    }
    .flex-col {
      flex-direction: column;
    }
    .flex-wrap {
      flex-wrap: wrap;
    }
    .flex-1 {
      flex: 1 1 0%;
    }
    .flex-grow {
      flex-grow: 1;
    }
    .items-start {
      align-items: flex-start;
    }
    .items-center {
      align-items: center;
    }
    .justify-between {
      justify-content: space-between;
    }
    .text-center {
      text-align: center;
    }
    .text-right {
      text-align: right;
    }
    .text-sm {
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .text-xs {
      font-size: 0.75rem;
      line-height: 1rem;
    }
    .text-lg {
      font-size: 1.125rem;
      line-height: 1.75rem;
    }
    .text-xl {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }
    .text-2xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }
    .text-3xl {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }
    .font-medium {
      font-weight: 500;
    }
    .font-semibold {
      font-weight: 600;
    }
    .font-bold {
      font-weight: 700;
    }
    .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .text-white {
      color: #ffffff;
    }
    .text-blue-700 {
      color: var(--blue-700);
    }
    .text-blue-800 {
      color: var(--blue-800);
    }
    .text-emerald-700 {
      color: var(--emerald-700);
    }
    .text-emerald-800 {
      color: var(--emerald-800);
    }
    .text-stone-500 {
      color: var(--stone-500);
    }
    .text-stone-600 {
      color: var(--stone-600);
    }
    .text-stone-700 {
      color: var(--stone-700);
    }
    .text-stone-800 {
      color: var(--stone-800);
    }
    .text-stone-900 {
      color: var(--stone-900);
    }
    .text-teal-600 {
      color: var(--teal-600);
    }
    .text-teal-700 {
      color: var(--teal-700);
    }
    .text-teal-800 {
      color: var(--teal-800);
    }
    .text-teal-900 {
      color: var(--teal-900);
    }
    input[type='radio'].text-teal-600 {
      accent-color: var(--teal-600);
    }
    .bg-white {
      background-color: #ffffff;
    }
    .bg-stone-50 {
      background-color: var(--stone-50);
    }
    .bg-stone-200 {
      background-color: var(--stone-200);
    }
    .bg-stone-700 {
      background-color: var(--stone-700);
    }
    .bg-teal-50 {
      background-color: var(--teal-50);
    }
    .bg-teal-100 {
      background-color: var(--teal-100);
    }
    .bg-teal-600 {
      background-color: var(--teal-600);
    }
    .bg-blue-50 {
      background-color: var(--blue-50);
    }
    .bg-emerald-50 {
      background-color: var(--emerald-50);
    }
    .bg-rose-600 {
      background-color: var(--rose-600);
    }
    .hover\:bg-teal-700:hover {
      background-color: var(--teal-700);
    }
    .hover\:bg-rose-700:hover {
      background-color: var(--rose-700);
    }
    .hover\:bg-stone-50:hover {
      background-color: var(--stone-50);
    }
    .hover\:bg-stone-800:hover {
      background-color: var(--stone-800);
    }
    .w-full {
      width: 100%;
    }
    .w-1\/2 {
      width: 50%;
    }
    .h-4 {
      height: 1rem;
    }
    .w-4 {
      width: 1rem;
    }
    .h-48 {
      height: 12rem;
    }
    .overflow-y-auto {
      overflow-y: auto;
    }
    .border {
      border: 1px solid var(--stone-200);
    }
    .border-b {
      border-bottom: 1px solid currentColor;
    }
    .border-t-2 {
      border-top: 2px solid currentColor;
    }
    .border-dashed {
      border-style: dashed;
    }
    .border-stone-100 {
      border-color: var(--stone-100);
    }
    .border-stone-200 {
      border-color: var(--stone-200);
    }
    .border-stone-300 {
      border-color: var(--stone-300);
    }
    .rounded {
      border-radius: 0.25rem;
    }
    .rounded-md {
      border-radius: 0.375rem;
    }
    .rounded-lg {
      border-radius: 0.5rem;
    }
    .rounded-full {
      border-radius: 9999px;
    }
    .shadow-sm {
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }
    .shadow-md {
      box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.1), 0 2px 4px -2px rgba(15, 23, 42, 0.1);
    }
    .ring-2 {
      outline: 2px solid var(--ring-color, var(--ring-default));
      outline-offset: 2px;
    }
    .ring-teal-500 {
      --ring-color: rgba(20, 184, 166, 0.55);
    }
    .transition-all,
    .transition-colors {
      transition-duration: 150ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .transition-all {
      transition-property: all;
    }
    .transition-colors {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    }
    .duration-300 {
      transition-duration: 300ms;
    }
    .ease-in-out {
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .list-disc {
      list-style-type: disc;
    }
    .list-inside {
      list-style-position: inside;
    }
    .status-tovisit {
      background-color: #ffffff;
    }
    .status-visited {
      background-color: #dcfce7;
      color: #166534;
    }
    .status-dropped {
      background-color: #fee2e2;
      color: #991b1b;
      text-decoration: line-through;
    }
    .recommendation-stay {
      color: #0f766e;
    }
    .recommendation-leave {
      color: #be123c;
    }
    </style>
  </head>
  <body class="text-stone-800" data-active-day-id="Fri">
    <script id="itinerary-data" type="application/json">{"runTimestamp":"2025-09-18T06:18:34.792Z","runId":"RX-v2","runNote":"Buffalo in the AM, long run to Roxbury. Skip Rochester","days":[{"dayId":"Fri","stops":[{"id":"HRBs","name":"Hyatt Regency Buffalo / Hotel and Conference Center","type":"start","arrive":"10:00","depart":"10:00","lat":42.8879852,"lon":-78.8768433},{"id":"ATSWS","name":"AMVETS Thrift Store West Seneca","type":"store","arrive":"10:08","depart":"10:38","lat":42.828791050897,"lon":-78.784309435252,"address":"1900 Ridge Rd, West Seneca, NY 14224","dwellMin":30,"legIn":{"fromId":"HRBs","toId":"ATSWS","driveMin":8.293827801817349,"distanceMi":6.220370851363012},"score":4.1,"tags":["Thrift"]},{"id":"AB","name":"AMVETS Buffalo","type":"store","arrive":"10:51","depart":"11:21","lat":42.945290339859,"lon":-78.878246854094,"address":"1833 Elmwood Ave, Buffalo, NY 14207","dwellMin":30,"legIn":{"fromId":"ATSWS","toId":"AB","driveMin":12.465675417663176,"distanceMi":9.349256563247382},"score":4.6,"tags":["must-visit","Thrift"]},{"id":"HTSHFB","name":"Hearts Thrift Store - Hearts for the Homeless Thrift Store (Buffalo)","type":"store","arrive":"11:23","depart":"11:53","lat":42.952777142833,"lon":-78.905501188492,"address":"890 Tonawanda St, Buffalo, NY 14207","dwellMin":30,"legIn":{"fromId":"AB","toId":"HTSHFB","driveMin":1.9629818777659207,"distanceMi":1.4722364083244406},"score":4.3,"tags":["Thrift"]},{"id":"HTSHFT","name":"Hearts Thrift Store - Hearts for the Homeless Thrift Store (Tonawanda)","type":"store","arrive":"11:57","depart":"12:27","lat":42.980811214442,"lon":-78.850974884193,"address":"2217 Sheridan Dr, Buffalo, NY 14223","dwellMin":30,"legIn":{"fromId":"HTSHFB","toId":"HTSHFT","driveMin":4.492364472917948,"distanceMi":3.369273354688461},"score":4,"tags":["Thrift"]},{"id":"SAVERST","name":"Savers","type":"store","arrive":"12:29","depart":"12:59","lat":42.981112399689,"lon":-78.825751077632,"address":"2309 Eggert Rd, Tonawanda Town, NY 14150","dwellMin":30,"legIn":{"fromId":"HTSHFT","toId":"SAVERST","driveMin":1.7002395628293903,"distanceMi":1.2751796721220428},"score":5,"tags":["must-visit","Thrift"]},{"id":"AWFM","name":"Antique World & Flea Market","type":"store","arrive":"13:16","depart":"13:46","lat":42.983831250138,"lon":-78.572300161758,"address":"11111 Main St, Clarence, NY 14031","dwellMin":30,"legIn":{"fromId":"SAVERST","toId":"AWFM","driveMin":17.083284483704013,"distanceMi":12.81246336277801},"score":4.8,"tags":["Antique"]},{"id":"GJE","name":"Grandma Jaree's Emporium","type":"store","arrive":"16:01","depart":"16:31","lat":42.932716334904,"lon":-76.572979661258,"address":"25 McMaster St, Auburn, NY 13021","dwellMin":30,"legIn":{"fromId":"AWFM","toId":"GJE","driveMin":134.87728995937007,"distanceMi":101.15796746952756},"score":4.9,"tags":["must-visit","Junk"]},{"id":"ROXe","name":"Roxbury","type":"end","arrive":"18:60","depart":"18:60","lat":42.2839,"lon":-74.5651,"legIn":{"fromId":"GJE","toId":"ROXe","driveMin":148.6809710095119,"distanceMi":111.51072825713393}}],"excluded":[{"id":"2TAC","reason":"timeWindow","nearestAlternateId":"SAVERST"},{"id":"AFAC","reason":"timeWindow","nearestAlternateId":"AWFM"},{"id":"ATBR","reason":"timeWindow","nearestAlternateId":"HTSHFT"},{"id":"BRV","reason":"timeWindow","nearestAlternateId":"AB"},{"id":"CGAE","reason":"timeWindow","nearestAlternateId":"SAVERST"},{"id":"COO","reason":"timeWindow","nearestAlternateId":"AB"},{"id":"FLTT","reason":"timeWindow","nearestAlternateId":"GJE"},{"id":"FTVA","reason":"timeWindow","nearestAlternateId":"SAVERST"},{"id":"HA","reason":"timeWindow","nearestAlternateId":"AWFM"},{"id":"HFHR","reason":"timeWindow","nearestAlternateId":"GJE"},{"id":"HFHRN","reason":"timeWindow","nearestAlternateId":"SAVERST"},{"id":"HFHRS","reason":"timeWindow","nearestAlternateId":"ATSWS"},{"id":"OHVC","reason":"timeWindow","nearestAlternateId":"AB"},{"id":"PLAM","reason":"timeWindow","nearestAlternateId":"GJE"},{"id":"SA","reason":"timeWindow","nearestAlternateId":"AB"},{"id":"SCBAC","reason":"timeWindow","nearestAlternateId":"SAVERST"},{"id":"SDDS","reason":"timeWindow","nearestAlternateId":"AB"},{"id":"SLADD","reason":"timeWindow","nearestAlternateId":"ATSWS"},{"id":"STR","reason":"timeWindow","nearestAlternateId":"AB"}],"metrics":{"storeCount":24,"storesVisited":7,"visitedIds":["ATSWS","AB","HTSHFB","HTSHFT","SAVERST","AWFM","GJE"],"totalScore":31.700000000000003,"scorePerStore":4.528571428571429,"scorePerMin":0.05875194181301838,"scorePerDriveMin":0.09618984014648352,"scorePerMile":0.12825312019531138,"totalDriveMin":329.5566345855798,"totalDwellMin":210,"slackMin":60.443365414420214,"totalDistanceMiles":247.16747593918484,"onTimeRisk":0}}]}</script>
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
      <header class="mb-6">
        <h1 class="text-3xl font-bold text-stone-900">Rust Belt Bandit Planner</h1>
        <div id="run-info" class="text-stone-600 mt-1 text-sm space-x-0">
          <span class="font-semibold">Run ID:</span>
          <span class="ml-1">RX-v2</span>
          <span class="ml-2 text-stone-500">Buffalo in the AM, long run to Roxbury. Skip Rochester</span>
        </div>
        <p class="text-xs text-stone-500 mt-1">Generated 2025-09-18T06:18:34.792Z</p>
        <p id="active-day-label" class="text-sm text-stone-600 mt-2">Day Fri</p>
      </header>
      <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-1 bg-white p-4 rounded-lg shadow-sm">
          <h2 class="text-xl font-semibold mb-3">Itinerary</h2>
          <div id="itinerary-list" class="space-y-2">
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="ATSWS"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">AMVETS Thrift Store West Seneca</p>
                  <p class="text-xs text-stone-500">10:08 – 10:38</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.1</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="AB"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">AMVETS Buffalo</p>
                  <p class="text-xs text-stone-500">10:51 – 11:21</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.6</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="HTSHFB"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Hearts Thrift Store - Hearts for the Homeless Thrift Store (Buffalo)</p>
                  <p class="text-xs text-stone-500">11:23 – 11:53</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.3</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="HTSHFT"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Hearts Thrift Store - Hearts for the Homeless Thrift Store (Tonawanda)</p>
                  <p class="text-xs text-stone-500">11:57 – 12:27</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="SAVERST"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Savers</p>
                  <p class="text-xs text-stone-500">12:29 – 12:59</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">5.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="AWFM"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Antique World &amp; Flea Market</p>
                  <p class="text-xs text-stone-500">13:16 – 13:46</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.8</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="GJE"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Grandma Jaree&#39;s Emporium</p>
                  <p class="text-xs text-stone-500">16:01 – 16:31</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.9</p>
                </div>
              </div>
            </div>
          </div>
          <noscript>
            <div class="mt-4 space-y-3 text-sm text-stone-600">
              <div>
                <p class="font-semibold">Day Fri</p>
                <ul class="list-disc list-inside text-xs text-stone-500">
                  <li>10:00 – 10:00 · Hyatt Regency Buffalo &#x2F; Hotel and Conference Center (start)</li>
                  <li>10:08 – 10:38 · AMVETS Thrift Store West Seneca (store)</li>
                  <li>10:51 – 11:21 · AMVETS Buffalo (store)</li>
                  <li>11:23 – 11:53 · Hearts Thrift Store - Hearts for the Homeless Thrift Store (Buffalo) (store)</li>
                  <li>11:57 – 12:27 · Hearts Thrift Store - Hearts for the Homeless Thrift Store (Tonawanda) (store)</li>
                  <li>12:29 – 12:59 · Savers (store)</li>
                  <li>13:16 – 13:46 · Antique World &amp; Flea Market (store)</li>
                  <li>16:01 – 16:31 · Grandma Jaree&#39;s Emporium (store)</li>
                  <li>18:60 – 18:60 · Roxbury (end)</li>
                </ul>
              </div>
            </div>
          </noscript>
        </section>
        <section class="lg:col-span-1 flex flex-col gap-6">
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-1">Current Stop</h2>
            <p id="current-store-name" class="text-2xl font-bold text-teal-700">Loading...</p>
            <div id="store-timeline" class="mt-4">
              <h3 class="text-sm font-medium text-stone-600 mb-2">Visit Timeline</h3>
              <div class="flex items-center justify-between text-xs text-center">
                <div class="flex-1">
                  <p id="timeline-arrive-time" class="font-semibold">--:--</p>
                  <p class="text-stone-500">Arrive</p>
                </div>
                <div class="flex-1 border-t-2 border-dashed border-stone-300 mx-2"></div>
                <div class="flex-1">
                  <p id="timeline-mqa-time" class="font-semibold">--:--</p>
                  <p class="text-stone-500">MQA Check-in</p>
                </div>
                <div class="flex-1 border-t-2 border-dashed border-stone-300 mx-2"></div>
                <div class="flex-1">
                  <p class="font-semibold">Now</p>
                  <p class="text-stone-500">Decision</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm flex-grow">
            <h2 class="text-xl font-semibold mb-3">Measured Quality Assessment (MQA)</h2>
            <div id="mqa-form" class="space-y-3">
              <p class="text-sm text-stone-600">
                After 30 minutes, assess the store's quality:
              </p>
              <div id="mqa-select" class="grid grid-cols-2 gap-3"></div>
              <div class="flex gap-3 pt-3">
                <button
                  id="decision-button"
                  class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors"
                >
                  Process MQA
                </button>
                <button
                  id="bust-button"
                  class="w-1/2 bg-rose-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-700 transition-colors"
                >
                  Bust!
                </button>
              </div>
            </div>
            <div id="recommendation-display" class="mt-4 text-center"></div>
          </div>
        </section>
        <section class="lg:col-span-1 flex flex-col gap-6">
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-3">Dashboard</h2>
            <div class="grid grid-cols-2 gap-4 text-center">
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-total-stores">0</p>
                <p class="text-sm text-stone-600">Total Stores</p>
              </div>
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-stores-visited">0</p>
                <p class="text-sm text-stone-600">Stores Visited</p>
              </div>
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-avg-jscore">0.0</p>
                <p class="text-sm text-stone-600">Avg. J-Score</p>
              </div>
              <div class="bg-teal-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-teal-800" id="dashboard-expected-quality">0.0</p>
                <p class="text-sm text-teal-700">Remaining Posterior μ</p>
              </div>
              <div class="bg-teal-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-teal-800" id="dashboard-pool-uncertainty">±0.0</p>
                <p class="text-sm text-teal-700">Remaining Uncertainty σ</p>
              </div>
              <div class="bg-blue-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-blue-800" id="dashboard-current-mean">0.0</p>
                <p class="text-sm text-blue-700">Current Posterior μ</p>
              </div>
              <div class="bg-blue-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-blue-800" id="dashboard-current-uncertainty">±0.0</p>
                <p class="text-sm text-blue-700">Current Uncertainty σ</p>
              </div>
              <div class="bg-emerald-50 p-3 rounded-md col-span-2">
                <p class="text-2xl font-bold text-emerald-800" id="dashboard-current-ucb">0.0</p>
                <p class="text-sm text-emerald-700">Current Upper Confidence Bound (UCB) Score</p>
              </div>
              <div class="bg-teal-100 p-3 rounded-md col-span-2">
                <p class="text-2xl font-bold text-teal-900" id="dashboard-remaining-ucb">0.0</p>
                <p class="text-sm text-teal-900">Remaining Upper Confidence Bound (UCB) Score</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm flex-grow">
            <h2 class="text-xl font-semibold mb-3">Trip Log</h2>
            <div id="trip-log" class="text-sm space-y-2 overflow-y-auto h-48">
              <p class="text-stone-500">Your decisions will appear here.</p>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <button
              id="export-button"
              class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-stone-800 transition-colors"
            >
              Export Trip Data
            </button>
          </div>
        </section>
      </main>
    </div>
    <script>
    (function () {
      'use strict';
    
      const SCORE_MIN = 0;
      const SCORE_MAX = 5;
      const SCORE_RANGE = SCORE_MAX - SCORE_MIN;
      const EPSILON = 1e-6;
    
      const appState = {
        itinerary: null,
        stops: [],
        currentIndex: 0,
        log: [],
        dayId: null,
        mqaMap: {
          Bust: 0.0,
          Average: 3.5,
          Good: 4.2,
          Exceptional: 5.0,
        },
        posteriorConfig: {
          priorStrength: 4,
          baseAlpha: EPSILON,
          baseBeta: EPSILON,
          credibleZ: 1.0,
          defaultScore: 3.5,
        },
        posteriorPool: {
          observedAlpha: 0,
          observedBeta: 0,
          observationCount: 0,
          totalObservedQuality: 0,
          lastObservation: null,
        },
      };
    
      document.addEventListener('DOMContentLoaded', init);
    
      function createMapsUrl(stop) {
        if (!stop) return null;
    
        const queryParts = [];
        const hasLat = typeof stop.lat === 'number' && Number.isFinite(stop.lat);
        const hasLon = typeof stop.lon === 'number' && Number.isFinite(stop.lon);
        if (hasLat && hasLon) {
          queryParts.push(`${stop.lat},${stop.lon}`);
        }
    
        if (typeof stop.name === 'string' && stop.name.trim()) {
          queryParts.push(stop.name.trim());
        }
    
        if (typeof stop.address === 'string' && stop.address.trim()) {
          queryParts.push(stop.address.trim());
        }
    
        if (queryParts.length === 0) {
          return null;
        }
    
        const query = encodeURIComponent(queryParts.join(' '));
        return `https://www.google.com/maps/search/?api=1&query=${query}`;
      }
    
      function init() {
        const dataElement = document.getElementById('itinerary-data');
        if (!dataElement) {
          console.error('Itinerary data script tag not found.');
          return;
        }
    
        try {
          appState.itinerary = JSON.parse(dataElement.textContent || '{}');
        } catch (err) {
          console.error('Failed to parse itinerary JSON.', err);
          return;
        }
    
        const days = Array.isArray(appState.itinerary?.days)
          ? appState.itinerary.days
          : [];
        const activeDayId = document.body?.dataset?.activeDayId;
        const day =
          (activeDayId && days.find((d) => d?.dayId === activeDayId)) ||
          days.find((d) => Array.isArray(d?.stops) && d.stops.length > 0) ||
          days.find(() => true);
        if (!day) {
          console.error('Unable to determine active day for itinerary.');
          return;
        }
    
        appState.dayId = day.dayId ?? null;
        if (document.body && appState.dayId) {
          document.body.dataset.activeDayId = appState.dayId;
        }
    
        const dayLabel = document.getElementById('active-day-label');
        if (dayLabel && day.dayId) {
          dayLabel.textContent = `Day ${day.dayId}`;
        }
    
        const stops = Array.isArray(day.stops) ? day.stops : [];
        appState.stops = stops
          .filter((stop) => stop.type === 'store')
          .map((stop) => ({
            ...stop,
            status: 'tovisit',
            posterior: createPosterior(stop.score),
            mapsUrl: createMapsUrl(stop),
          }));
    
        appState.currentIndex = appState.stops.findIndex((s) => s.status === 'tovisit');
        if (appState.currentIndex === -1) {
          appState.currentIndex = appState.stops.length;
        }
    
        const runInfo = document.getElementById('run-info');
        if (runInfo && appState.itinerary) {
          const existing = runInfo.textContent?.trim();
          if (!existing) {
            const runId = appState.itinerary.runId ?? 'Unknown Run';
            const runNote = appState.itinerary.runNote ? ` - ${appState.itinerary.runNote}` : '';
            runInfo.textContent = `Run ID: ${runId}${runNote}`;
          }
        }
    
        setupMQAOptions();
        renderAll();
        addEventListeners();
      }
    
      function setupMQAOptions() {
        const container = document.getElementById('mqa-select');
        if (!container) return;
        container.innerHTML = '';
        Object.entries(appState.mqaMap).forEach(([key, value]) => {
          const div = document.createElement('div');
          div.className = 'flex items-center p-3 rounded-lg border border-stone-200 hover:bg-stone-50';
          div.innerHTML = `
            <input id="mqa-${key.toLowerCase()}" type="radio" name="mqa" value="${key}" class="h-4 w-4 text-teal-600 border-stone-300 focus:ring-teal-500">
            <label for="mqa-${key.toLowerCase()}" class="ml-3 block text-sm font-medium text-stone-700">
              ${key} <span class="text-xs text-stone-500">(${value.toFixed(1)})</span>
            </label>
          `;
          container.appendChild(div);
        });
      }
    
      function renderAll() {
        const currentStop = appState.stops[appState.currentIndex];
        const metrics = calculateMetrics(currentStop?.id);
        renderDashboard(metrics);
        renderItineraryList(currentStop);
        renderCurrentStore(currentStop);
        renderTripLog();
      }
    
      function calculateMetrics(excludeId) {
        const totalStores = appState.stops.length;
        const visitedStores = appState.stops.filter((s) => s.status === 'visited').length;
        const overallAvgScore =
          totalStores > 0
            ? (
                appState.stops.reduce(
                  (sum, s) => sum + (typeof s.score === 'number' ? s.score : appState.posteriorConfig.defaultScore),
                  0,
                ) / totalStores
              ).toFixed(1)
            : '0.0';
    
        const poolPosterior = computeRemainingPoolPosterior(excludeId);
        const currentStop = appState.stops[appState.currentIndex];
    
        return {
          totalStores,
          visitedStores,
          overallAvgScore,
          poolPosterior,
          currentPosterior: currentStop ? currentStop.posterior : null,
          expectedRemQuality: poolPosterior ? poolPosterior.mean.toFixed(2) : '0.0',
        };
      }
    
      function renderDashboard(metrics) {
        const {
          totalStores,
          visitedStores,
          overallAvgScore,
          poolPosterior,
          currentPosterior,
        } = metrics;
    
        setText('dashboard-total-stores', totalStores);
        setText('dashboard-stores-visited', visitedStores);
        setText('dashboard-avg-jscore', overallAvgScore);
        setText(
          'dashboard-expected-quality',
          poolPosterior ? poolPosterior.mean.toFixed(2) : '--',
        );
        setText(
          'dashboard-pool-uncertainty',
          poolPosterior ? `±${poolPosterior.std.toFixed(2)}` : '±--',
        );
        setText(
          'dashboard-current-mean',
          currentPosterior ? currentPosterior.mean.toFixed(2) : '--',
        );
        setText(
          'dashboard-current-uncertainty',
          currentPosterior ? `±${currentPosterior.std.toFixed(2)}` : '±--',
        );
        const currentUcbText =
          currentPosterior && typeof currentPosterior.upper === 'number'
            ? currentPosterior.upper.toFixed(2)
            : '--';
        const remainingUcbText =
          poolPosterior && typeof poolPosterior.upper === 'number'
            ? poolPosterior.upper.toFixed(2)
            : '--';
        setText('dashboard-current-ucb', currentUcbText);
        setText('dashboard-remaining-ucb', remainingUcbText);
      }
    
      function renderItineraryList(currentStop) {
        const container = document.getElementById('itinerary-list');
        if (!container) return;
        container.innerHTML = '';
        appState.stops.forEach((stop, index) => {
          const isCurrent = currentStop && stop.id === currentStop.id && stop.status === 'tovisit';
          const div = document.createElement('div');
          div.id = `row-${stop.id}`;
          div.className = `p-3 rounded-md transition-all duration-300 ease-in-out status-${stop.status} ${
            isCurrent ? 'ring-2 ring-teal-500 shadow-md' : 'shadow-sm'
          }`;
          const posteriorMean = stop.posterior ? stop.posterior.mean.toFixed(2) : formatScore(stop.score);
          const posteriorStd = stop.posterior ? stop.posterior.std.toFixed(2) : '0.00';
          const statusLabel =
            stop.status === 'visited'
              ? `Visited – ${stop.mqa ?? 'n/a'}`
              : stop.status === 'dropped'
              ? 'Dropped'
              : 'To Visit';
          const nameMarkup = stop.mapsUrl
            ? `<a class="store-link" href="${stop.mapsUrl}" target="_blank" rel="noopener noreferrer">${stop.name}</a>`
            : stop.name;
          const dropButtonHtml =
            stop.status === 'tovisit'
              ? `<button type="button" class="drop-store-button mt-1 transition-colors" data-drop-stop-id="${stop.id}">Drop store</button>`
              : '';
          div.innerHTML = `
            <div class="flex justify-between items-start gap-3">
              <div>
                <p class="font-semibold">${nameMarkup}</p>
                <p class="text-xs text-stone-500">${statusLabel}</p>
              </div>
              <div class="flex flex-col items-end text-right gap-1">
                <div>
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">${posteriorMean}</p>
                  <p class="text-xs text-stone-500">±${posteriorStd}</p>
                </div>
                ${dropButtonHtml}
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      }
    
      function renderCurrentStore(currentStop) {
        const nameEl = document.getElementById('current-store-name');
        const form = document.getElementById('mqa-form');
        if (!nameEl || !form) return;
    
        if (!currentStop || currentStop.status !== 'tovisit') {
          nameEl.textContent = 'Trip Complete!';
          form.style.display = 'none';
          setText('timeline-arrive-time', '--:--');
          setText('timeline-mqa-time', '--:--');
          return;
        }
    
        form.style.display = 'block';
        nameEl.textContent = currentStop.name;
        if (currentStop.mapsUrl) {
          nameEl.innerHTML = `<a class="store-link" href="${currentStop.mapsUrl}" target="_blank" rel="noopener noreferrer">${currentStop.name}</a>`;
        }
    
        const [arriveH, arriveM] = currentStop.arrive.split(':').map(Number);
        const mqaTime = new Date();
        mqaTime.setHours(arriveH, arriveM + 30, 0, 0);
        const mqaH = String(mqaTime.getHours()).padStart(2, '0');
        const mqaM = String(mqaTime.getMinutes()).padStart(2, '0');
    
        setText('timeline-arrive-time', currentStop.arrive);
        setText('timeline-mqa-time', `${mqaH}:${mqaM}`);
      }
    
      function renderTripLog() {
        const container = document.getElementById('trip-log');
        if (!container) return;
    
        if (appState.log.length === 0) {
          container.innerHTML = '<p class="text-stone-500">Your decisions will appear here.</p>';
          return;
        }
    
        container.innerHTML = '';
        appState.log.forEach((entry) => {
          const div = document.createElement('div');
          div.className = 'p-2 border-b border-stone-100';
          const posterior = entry.posterior;
          const pool = entry.pool;
          const mqaValueText = entry.mqaValue != null ? ` (${entry.mqaValue.toFixed(1)})` : '';
          const zScoreText = entry.zScore != null ? ` | z=${entry.zScore.toFixed(2)}` : '';
          const nameHtml = entry.mapsUrl
            ? `<a class="store-link" href="${entry.mapsUrl}" target="_blank" rel="noopener noreferrer">${entry.name}</a>`
            : entry.name;
          const currentUcbText =
            entry.currentUcb != null && Number.isFinite(entry.currentUcb)
              ? entry.currentUcb.toFixed(2)
              : '--';
          const remainingUcbText =
            entry.remainingUcb != null && Number.isFinite(entry.remainingUcb)
              ? entry.remainingUcb.toFixed(2)
              : '--';
          div.innerHTML = `
            <p class="font-medium">${nameHtml}</p>
            <p class="text-stone-600">MQA: <span class="font-semibold">${entry.mqa}</span>${mqaValueText} → Decision: <span class="font-semibold">${entry.decision}</span></p>
            <p class="text-xs text-stone-500">Posterior μ=${posterior.mean.toFixed(2)} σ=${posterior.std.toFixed(2)} | Upper Confidence Bound (UCB)=${currentUcbText} | Pool μ=${pool.mean.toFixed(2)} σ=${pool.std.toFixed(2)} | Pool Upper Confidence Bound (UCB)=${remainingUcbText}${
            zScoreText ? ` ${zScoreText}` : ''
          }</p>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      }
    
      function processDecision(mqaKey) {
        const currentStop = appState.stops[appState.currentIndex];
        if (!currentStop) return;
    
        const mqaValue = appState.mqaMap[mqaKey];
        if (typeof mqaValue !== 'number') {
          console.warn('Unknown MQA key selected:', mqaKey);
          return;
        }
    
        updateStopPosterior(currentStop, mqaValue);
        updatePoolObservation(mqaValue);
    
        const poolPosterior = computeRemainingPoolPosterior(currentStop.id);
        const decisionMeta = getRecommendation(
          currentStop.posterior,
          poolPosterior,
          mqaKey,
          mqaValue,
        );
        const recommendation = decisionMeta.decision;
    
        updateRecommendationDisplay(recommendation, decisionMeta, currentStop.posterior, poolPosterior);
    
        currentStop.mqa = mqaKey;
        currentStop.mqaValue = mqaValue;
        currentStop.decision = recommendation;
        currentStop.decisionReason = decisionMeta.reason;
        currentStop.status = 'visited';
        currentStop.posteriorSummary = serializePosterior(currentStop.posterior);
        currentStop.posteriorSummary.diff = decisionMeta.diff;
        currentStop.posteriorSummary.zScore = decisionMeta.zScore;
        currentStop.posteriorSummary.currentUcb = decisionMeta.currentUcb ?? null;
        currentStop.posteriorSummary.remainingUcb = decisionMeta.remainingUcb ?? null;
    
        appState.log.push({
          name: currentStop.name,
          mapsUrl: currentStop.mapsUrl,
          mqa: mqaKey,
          mqaValue,
          decision: recommendation,
          decisionReason: decisionMeta.reason,
          diff: decisionMeta.diff,
          zScore: decisionMeta.zScore,
          currentUcb: decisionMeta.currentUcb ?? null,
          remainingUcb: decisionMeta.remainingUcb ?? null,
          observationCount: decisionMeta.observationCount ?? null,
          posterior: serializePosterior(currentStop.posterior),
          pool: serializePool(poolPosterior),
          timestamp: new Date().toISOString(),
        });
    
        renderAll();
    
        if (recommendation === 'Stay' && mqaKey === 'Exceptional') {
          handleOverrun();
        } else {
          advanceToNextStore();
        }
      }
    
      function updateRecommendationDisplay(recommendation, meta, currentPosterior, poolPosterior) {
        const display = document.getElementById('recommendation-display');
        if (!display) return;
        const diffText =
          meta.diff != null
            ? `ΔUpper Confidence Bound (UCB)=${meta.diff.toFixed(2)}`
            : '';
        const zText = meta.zScore != null && Number.isFinite(meta.zScore) ? `z=${meta.zScore.toFixed(2)}` : '';
        const reason = humanizeReason(meta.reason);
        const currentUcbText =
          meta.currentUcb != null && Number.isFinite(meta.currentUcb)
            ? meta.currentUcb.toFixed(2)
            : '--';
        const currentSummary = currentPosterior
          ? `Current μ=${currentPosterior.mean.toFixed(2)} σ=${currentPosterior.std.toFixed(2)} Upper Confidence Bound (UCB)=${currentUcbText}`
          : '';
        const poolUcbText =
          meta.remainingUcb != null && Number.isFinite(meta.remainingUcb)
            ? meta.remainingUcb.toFixed(2)
            : '--';
        const poolSummary = poolPosterior
          ? `Pool μ=${poolPosterior.mean.toFixed(2)} σ=${poolPosterior.std.toFixed(2)} Upper Confidence Bound (UCB)=${poolUcbText}`
          : '';
    
        const metaLine = [reason, diffText, zText].filter(Boolean).join(' · ');
        const summaryLine = [currentSummary, poolSummary].filter(Boolean).join(' | ');
    
        display.innerHTML = `
          <p class="text-lg font-medium">Recommendation:</p>
          <p class="text-3xl font-bold recommendation-${recommendation.toLowerCase()}">${recommendation.toUpperCase()}</p>
          <p class="text-sm text-stone-600">${metaLine}</p>
          <p class="text-xs text-stone-500">${summaryLine}</p>
        `;
      }
    
      function dropStopById(stopId, reason) {
        const normalizedId = String(stopId);
        const stopIndex = appState.stops.findIndex((s) => String(s.id) === normalizedId);
        if (stopIndex === -1) return null;
    
        const stop = appState.stops[stopIndex];
        if (stop.status !== 'tovisit') {
          return null;
        }
    
        stop.status = 'dropped';
        stop.decision = 'Dropped';
        stop.decisionReason = reason;
    
        const posteriorSummary = serializePosterior(stop.posterior);
        stop.posteriorSummary = {
          ...posteriorSummary,
          diff: null,
          zScore: null,
          currentUcb: null,
          remainingUcb: null,
        };
    
        const poolSnapshot = serializePool(computeRemainingPoolPosterior());
    
        appState.log.push({
          name: stop.name,
          mapsUrl: stop.mapsUrl,
          mqa: 'N/A',
          mqaValue: null,
          decision: 'Dropped',
          decisionReason: reason,
          diff: null,
          zScore: null,
          currentUcb: null,
          remainingUcb: null,
          observationCount: null,
          posterior: posteriorSummary,
          pool: poolSnapshot,
          timestamp: new Date().toISOString(),
        });
    
        return { stop, index: stopIndex };
      }
    
      function handleOverrun() {
        const remainingStops = appState.stops.filter((s) => s.status === 'tovisit');
        if (remainingStops.length === 0) {
          advanceToNextStore();
          return;
        }
    
        const lowestScoringStop = remainingStops.reduce((min, stop) =>
          stop.posterior.mean < min.posterior.mean ? stop : min,
        );
    
        setTimeout(() => {
          const confirmed = window.confirm(
            `To extend your stay, drop the lowest-rated remaining store:\n\n${lowestScoringStop.name} (Posterior μ: ${lowestScoringStop.posterior.mean.toFixed(
              2,
            )})\n\nDrop this store?`,
          );
    
          if (confirmed) {
            dropStopById(lowestScoringStop.id, 'overrun-drop-lowest');
          }
          advanceToNextStore();
        }, 500);
      }
    
      function advanceToNextStore() {
        let nextIndex = appState.currentIndex + 1;
        while (nextIndex < appState.stops.length && appState.stops[nextIndex].status !== 'tovisit') {
          nextIndex += 1;
        }
        appState.currentIndex = nextIndex;
    
        const selectedRadio = document.querySelector('input[name="mqa"]:checked');
        if (selectedRadio) selectedRadio.checked = false;
        const display = document.getElementById('recommendation-display');
        if (display) display.innerHTML = '';
    
        renderAll();
      }
    
      function addEventListeners() {
        const decisionButton = document.getElementById('decision-button');
        if (decisionButton) {
          decisionButton.addEventListener('click', () => {
            const selectedMQA = document.querySelector('input[name="mqa"]:checked');
            if (!selectedMQA) {
              window.alert('Please select a Measured Quality Assessment (MQA).');
              return;
            }
            processDecision(selectedMQA.value);
          });
        }
    
        const bustButton = document.getElementById('bust-button');
        if (bustButton) {
          bustButton.addEventListener('click', () => {
            processDecision('Bust');
          });
        }
    
        const itineraryList = document.getElementById('itinerary-list');
        if (itineraryList) {
          itineraryList.addEventListener('click', (event) => {
            const target = event.target;
            if (!(target instanceof Element)) {
              return;
            }
            const button = target.closest('button[data-drop-stop-id]');
            if (!button) {
              return;
            }
            event.preventDefault();
            const stopId = button.getAttribute('data-drop-stop-id');
            if (!stopId) {
              return;
            }
            const stop = appState.stops.find((s) => String(s.id) === stopId);
            if (!stop || stop.status !== 'tovisit') {
              return;
            }
            const confirmed = window.confirm(
              `Drop ${stop.name}?\n\nThis will mark the store as dropped.`,
            );
            if (!confirmed) {
              return;
            }
            const dropResult = dropStopById(stopId, 'manual-drop');
            if (!dropResult) {
              return;
            }
            if (dropResult.index === appState.currentIndex) {
              advanceToNextStore();
            } else {
              renderAll();
            }
          });
        }
    
        const exportButton = document.getElementById('export-button');
        if (exportButton) {
          exportButton.addEventListener('click', () => {
            const poolSnapshot = computeRemainingPoolPosterior();
            const exportData = {
              runInfo: appState.itinerary,
              activeDayId: appState.dayId,
              finalStopsState: appState.stops.map((stop) => ({
                id: stop.id,
                name: stop.name,
                type: stop.type,
                arrive: stop.arrive,
                depart: stop.depart,
                score: stop.score,
                status: stop.status,
                mqa: stop.mqa ?? null,
                mqaValue: stop.mqaValue ?? null,
                decision: stop.decision ?? null,
                decisionReason: stop.decisionReason ?? null,
                posterior: serializePosterior(stop.posterior),
              })),
              tripLog: appState.log,
              posteriorPool: {
                ...serializePool(poolSnapshot),
                observedAlpha: appState.posteriorPool.observedAlpha,
                observedBeta: appState.posteriorPool.observedBeta,
                observationCount: appState.posteriorPool.observationCount,
                totalObservedQuality: appState.posteriorPool.totalObservedQuality,
              },
              posteriorConfig: appState.posteriorConfig,
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            const runId = appState.itinerary?.runId ?? 'trip';
            a.download = `rust-belt-trip-${runId}-results.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
      }
    
      function getRecommendation(currentPosterior, poolPosterior, mqaKey, mqaValue) {
        const fallbackCurrentUcb = typeof mqaValue === 'number' ? mqaValue : null;
        const derivedCurrentUcb =
          currentPosterior && typeof currentPosterior.upper === 'number'
            ? currentPosterior.upper
            : null;
        const currentUcb = derivedCurrentUcb ?? fallbackCurrentUcb;
        const derivedRemainingUcb =
          poolPosterior && typeof poolPosterior.upper === 'number'
            ? poolPosterior.upper
            : null;
        const fallbackRemainingUcb =
          poolPosterior && typeof poolPosterior.mean === 'number'
            ? poolPosterior.mean
            : null;
        const remainingUcb = derivedRemainingUcb ?? fallbackRemainingUcb;
        const observationCount = currentPosterior?.observationCount ?? 0;
    
        if (mqaKey === 'Bust') {
          const diff =
            currentUcb != null && remainingUcb != null ? currentUcb - remainingUcb : currentUcb ?? null;
          return {
            decision: 'Leave',
            reason: 'mqa-bust',
            diff,
            zScore: null,
            currentUcb,
            remainingUcb,
            observationCount,
          };
        }
    
        if (!currentPosterior || currentUcb == null) {
          return {
            decision: 'Leave',
            reason: 'no-current-posterior',
            diff: null,
            zScore: null,
            currentUcb,
            remainingUcb,
            observationCount,
          };
        }
    
        if (!poolPosterior || poolPosterior.count === 0 || remainingUcb == null) {
          return {
            decision: 'Stay',
            reason: 'no-remaining-stops',
            diff: currentUcb,
            zScore: null,
            currentUcb,
            remainingUcb,
            observationCount,
          };
        }
    
        const diff = currentUcb - remainingUcb;
        const combinedStd = Math.sqrt(
          currentPosterior.std * currentPosterior.std + poolPosterior.std * poolPosterior.std,
        );
        const zScore =
          combinedStd > 0
            ? diff / combinedStd
            : diff >= 0
            ? Number.POSITIVE_INFINITY
            : Number.NEGATIVE_INFINITY;
    
        if (diff > 0) {
          return {
            decision: 'Stay',
            reason: 'ucb-favors-current',
            diff,
            zScore,
            currentUcb,
            remainingUcb,
            observationCount,
          };
        }
    
        return {
          decision: 'Leave',
          reason: diff === 0 ? 'ucb-tie' : 'ucb-favors-remaining',
          diff,
          zScore,
          currentUcb,
          remainingUcb,
          observationCount,
        };
      }
    
      function computeRemainingPoolPosterior(excludeId) {
        const remainingStops = appState.stops.filter(
          (s) => s.status === 'tovisit' && (!excludeId || s.id !== excludeId),
        );
    
        let pseudoAlpha = 0;
        let pseudoBeta = 0;
        remainingStops.forEach((stop) => {
          const priorNorm = stop.posterior?.priorNormalized ?? normalizeScore(stop.score);
          const pseudo = stop.posterior?.pseudo ?? appState.posteriorConfig.priorStrength;
          pseudoAlpha += priorNorm * pseudo;
          pseudoBeta += (1 - priorNorm) * pseudo;
        });
    
        const alpha = appState.posteriorConfig.baseAlpha + pseudoAlpha + appState.posteriorPool.observedAlpha;
        const beta = appState.posteriorConfig.baseBeta + pseudoBeta + appState.posteriorPool.observedBeta;
        const stats = computeBetaStats(alpha, beta);
        return {
          ...stats,
          count: remainingStops.length,
          pseudoAlpha,
          pseudoBeta,
          observationCount: appState.posteriorPool.observationCount,
          totalObservedQuality: appState.posteriorPool.totalObservedQuality,
        };
      }
    
      function createPosterior(baseScore) {
        const normalized = normalizeScore(baseScore);
        const pseudo = appState.posteriorConfig.priorStrength;
        const posterior = {
          alpha: appState.posteriorConfig.baseAlpha + normalized * pseudo,
          beta: appState.posteriorConfig.baseBeta + (1 - normalized) * pseudo,
          priorNormalized: normalized,
          pseudo,
          observationCount: 0,
          totalQuality: 0,
          lastObservation: null,
        };
        return recomputePosteriorStats(posterior);
      }
    
      function updateStopPosterior(stop, mqaValue) {
        const normalized = normalizeScore(mqaValue);
        stop.posterior.alpha += normalized;
        stop.posterior.beta += 1 - normalized;
        stop.posterior.observationCount = (stop.posterior.observationCount ?? 0) + 1;
        stop.posterior.totalQuality = (stop.posterior.totalQuality ?? 0) + mqaValue;
        stop.posterior.lastObservation = mqaValue;
        recomputePosteriorStats(stop.posterior);
      }
    
      function updatePoolObservation(mqaValue) {
        const normalized = normalizeScore(mqaValue);
        appState.posteriorPool.observedAlpha += normalized;
        appState.posteriorPool.observedBeta += 1 - normalized;
        appState.posteriorPool.observationCount += 1;
        appState.posteriorPool.totalObservedQuality += mqaValue;
        appState.posteriorPool.lastObservation = mqaValue;
      }
    
      function recomputePosteriorStats(posterior) {
        posterior.alpha = Math.max(posterior.alpha, EPSILON);
        posterior.beta = Math.max(posterior.beta, EPSILON);
        const total = posterior.alpha + posterior.beta;
        const meanNormalized = posterior.alpha / total;
        const varianceNormalized = (posterior.alpha * posterior.beta) / ((total + 1) * total * total);
        const stdScore = Math.sqrt(Math.max(varianceNormalized, 0)) * SCORE_RANGE;
        posterior.meanNormalized = meanNormalized;
        posterior.mean = denormalizeScore(meanNormalized);
        posterior.std = stdScore;
        posterior.lower = clamp(
          posterior.mean - appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        posterior.upper = clamp(
          posterior.mean + appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        posterior.variance = stdScore * stdScore;
        return posterior;
      }
    
      function computeBetaStats(alpha, beta) {
        const safeAlpha = Math.max(alpha, EPSILON);
        const safeBeta = Math.max(beta, EPSILON);
        const total = safeAlpha + safeBeta;
        const meanNormalized = safeAlpha / total;
        const varianceNormalized = (safeAlpha * safeBeta) / ((total + 1) * total * total);
        const stdScore = Math.sqrt(Math.max(varianceNormalized, 0)) * SCORE_RANGE;
        const meanScore = denormalizeScore(meanNormalized);
        const lower = clamp(
          meanScore - appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        const upper = clamp(
          meanScore + appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        return {
          alpha: safeAlpha,
          beta: safeBeta,
          meanNormalized,
          mean: meanScore,
          std: stdScore,
          variance: stdScore * stdScore,
          lower,
          upper,
        };
      }
    
      function serializePosterior(posterior) {
        return {
          alpha: posterior.alpha,
          beta: posterior.beta,
          mean: posterior.mean,
          meanNormalized: posterior.meanNormalized,
          std: posterior.std,
          variance: posterior.variance,
          lower: posterior.lower,
          upper: posterior.upper,
          observationCount: posterior.observationCount ?? 0,
          totalQuality: posterior.totalQuality ?? 0,
          lastObservation: posterior.lastObservation ?? null,
          priorNormalized: posterior.priorNormalized ?? null,
          pseudo: posterior.pseudo ?? appState.posteriorConfig.priorStrength,
        };
      }
    
      function serializePool(poolPosterior) {
        return {
          alpha: poolPosterior.alpha,
          beta: poolPosterior.beta,
          mean: poolPosterior.mean,
          meanNormalized: poolPosterior.meanNormalized,
          std: poolPosterior.std,
          variance: poolPosterior.variance,
          lower: poolPosterior.lower,
          upper: poolPosterior.upper,
          count: poolPosterior.count,
          pseudoAlpha: poolPosterior.pseudoAlpha,
          pseudoBeta: poolPosterior.pseudoBeta,
          observationCount: poolPosterior.observationCount,
          totalObservedQuality: poolPosterior.totalObservedQuality,
        };
      }
    
      function setText(id, value) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value;
      }
    
      function normalizeScore(value) {
        const safeValue = typeof value === 'number' ? value : appState.posteriorConfig.defaultScore;
        return clamp((safeValue - SCORE_MIN) / SCORE_RANGE, 0, 1);
      }
    
      function denormalizeScore(normalized) {
        return SCORE_MIN + clamp(normalized, 0, 1) * SCORE_RANGE;
      }
    
      function formatScore(value) {
        if (typeof value !== 'number') return '0.0';
        return value.toFixed(1);
      }
    
      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }
    
      function humanizeReason(reason) {
        if (!reason) return '';
        const text = reason
          .replace(/[-_]/g, ' ')
          .replace(/\b([a-z])/g, (m) => m.toUpperCase());
        return text
          .replace(/\bMqa\b/g, 'MQA')
          .replace(/\bUcb\b/g, 'Upper Confidence Bound (UCB)');
      }
    })();
    </script>
  </body>
</html>
