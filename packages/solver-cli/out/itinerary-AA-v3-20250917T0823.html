<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rust Belt Bandit Planner</title>
    <style>
    :root {
      --stone-50: #fafaf9;
      --stone-100: #f5f5f4;
      --stone-200: #e7e5e4;
      --stone-300: #d6d3d1;
      --stone-500: #78716c;
      --stone-600: #57534e;
      --stone-700: #44403c;
      --stone-800: #292524;
      --stone-900: #1c1917;
      --teal-50: #f0fdfa;
      --teal-100: #ccfbf1;
      --teal-600: #0d9488;
      --teal-700: #0f766e;
      --teal-800: #115e59;
      --teal-900: #134e4a;
      --blue-50: #eff6ff;
      --blue-700: #1d4ed8;
      --blue-800: #1e40af;
      --emerald-50: #ecfdf5;
      --emerald-700: #047857;
      --emerald-800: #065f46;
      --rose-600: #e11d48;
      --rose-700: #be123c;
      --ring-default: rgba(20, 184, 166, 0.45);
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      background-color: var(--stone-100);
      color: var(--stone-800);
      line-height: 1.5;
    }
    h1,
    h2,
    h3 {
      margin: 0;
      font-weight: 600;
      color: var(--stone-900);
    }
    p {
      margin: 0;
    }
    button,
    input,
    select {
      font: inherit;
      color: inherit;
    }
    button {
      border: none;
    }
    button:focus-visible,
    input:focus-visible {
      outline: 2px solid var(--teal-600);
      outline-offset: 2px;
    }
    .focus\:ring-teal-500:focus-visible {
      outline: 2px solid rgba(20, 184, 166, 0.75);
      outline-offset: 2px;
    }
    .container {
      width: 100%;
      margin-left: auto;
      margin-right: auto;
      padding-left: 1rem;
      padding-right: 1rem;
      max-width: 100%;
    }
    @media (min-width: 640px) {
      .container {
        max-width: 640px;
      }
    }
    @media (min-width: 768px) {
      .container {
        max-width: 768px;
      }
      .md\:p-6 {
        padding: 1.5rem;
      }
    }
    @media (min-width: 1024px) {
      .container {
        max-width: 1024px;
      }
      .lg\:grid-cols-3 {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
      .lg\:col-span-1 {
        grid-column: span 1 / span 1;
      }
      .lg\:p-8 {
        padding: 2rem;
      }
    }
    @media (min-width: 1280px) {
      .container {
        max-width: 1280px;
      }
    }
    .mx-auto {
      margin-left: auto;
      margin-right: auto;
    }
    .mt-1 {
      margin-top: 0.25rem;
    }
    .mt-2 {
      margin-top: 0.5rem;
    }
    .mt-4 {
      margin-top: 1rem;
    }
    .mb-1 {
      margin-bottom: 0.25rem;
    }
    .mb-2 {
      margin-bottom: 0.5rem;
    }
    .mb-3 {
      margin-bottom: 0.75rem;
    }
    .mb-6 {
      margin-bottom: 1.5rem;
    }
    .ml-1 {
      margin-left: 0.25rem;
    }
    .ml-2 {
      margin-left: 0.5rem;
    }
    .ml-3 {
      margin-left: 0.75rem;
    }
    .pt-3 {
      padding-top: 0.75rem;
    }
    .p-2 {
      padding: 0.5rem;
    }
    .p-3 {
      padding: 0.75rem;
    }
    .p-4 {
      padding: 1rem;
    }
    .px-2 {
      padding-left: 0.5rem;
      padding-right: 0.5rem;
    }
    .px-4 {
      padding-left: 1rem;
      padding-right: 1rem;
    }
    .py-1 {
      padding-top: 0.25rem;
      padding-bottom: 0.25rem;
    }
    .py-2 {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
    }
    .gap-2 {
      gap: 0.5rem;
    }
    .gap-3 {
      gap: 0.75rem;
    }
    .gap-4 {
      gap: 1rem;
    }
    .gap-6 {
      gap: 1.5rem;
    }
    .space-y-2 > * + * {
      margin-top: 0.5rem;
    }
    .space-y-3 > * + * {
      margin-top: 0.75rem;
    }
    .space-x-0 > * + * {
      margin-left: 0;
    }
    .grid {
      display: grid;
    }
    .grid-cols-1 {
      grid-template-columns: repeat(1, minmax(0, 1fr));
    }
    .grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
    .col-span-2 {
      grid-column: span 2 / span 2;
    }
    .flex {
      display: flex;
    }
    .flex-col {
      flex-direction: column;
    }
    .flex-wrap {
      flex-wrap: wrap;
    }
    .flex-1 {
      flex: 1 1 0%;
    }
    .flex-grow {
      flex-grow: 1;
    }
    .items-start {
      align-items: flex-start;
    }
    .items-center {
      align-items: center;
    }
    .justify-between {
      justify-content: space-between;
    }
    .text-center {
      text-align: center;
    }
    .text-right {
      text-align: right;
    }
    .text-sm {
      font-size: 0.875rem;
      line-height: 1.25rem;
    }
    .text-xs {
      font-size: 0.75rem;
      line-height: 1rem;
    }
    .text-lg {
      font-size: 1.125rem;
      line-height: 1.75rem;
    }
    .text-xl {
      font-size: 1.25rem;
      line-height: 1.75rem;
    }
    .text-2xl {
      font-size: 1.5rem;
      line-height: 2rem;
    }
    .text-3xl {
      font-size: 1.875rem;
      line-height: 2.25rem;
    }
    .font-medium {
      font-weight: 500;
    }
    .font-semibold {
      font-weight: 600;
    }
    .font-bold {
      font-weight: 700;
    }
    .font-mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .text-white {
      color: #ffffff;
    }
    .text-blue-700 {
      color: var(--blue-700);
    }
    .text-blue-800 {
      color: var(--blue-800);
    }
    .text-emerald-700 {
      color: var(--emerald-700);
    }
    .text-emerald-800 {
      color: var(--emerald-800);
    }
    .text-stone-500 {
      color: var(--stone-500);
    }
    .text-stone-600 {
      color: var(--stone-600);
    }
    .text-stone-700 {
      color: var(--stone-700);
    }
    .text-stone-800 {
      color: var(--stone-800);
    }
    .text-stone-900 {
      color: var(--stone-900);
    }
    .text-teal-600 {
      color: var(--teal-600);
    }
    .text-teal-700 {
      color: var(--teal-700);
    }
    .text-teal-800 {
      color: var(--teal-800);
    }
    .text-teal-900 {
      color: var(--teal-900);
    }
    input[type='radio'].text-teal-600 {
      accent-color: var(--teal-600);
    }
    .bg-white {
      background-color: #ffffff;
    }
    .bg-stone-50 {
      background-color: var(--stone-50);
    }
    .bg-stone-200 {
      background-color: var(--stone-200);
    }
    .bg-stone-700 {
      background-color: var(--stone-700);
    }
    .bg-teal-50 {
      background-color: var(--teal-50);
    }
    .bg-teal-100 {
      background-color: var(--teal-100);
    }
    .bg-teal-600 {
      background-color: var(--teal-600);
    }
    .bg-blue-50 {
      background-color: var(--blue-50);
    }
    .bg-emerald-50 {
      background-color: var(--emerald-50);
    }
    .bg-rose-600 {
      background-color: var(--rose-600);
    }
    .hover\:bg-teal-700:hover {
      background-color: var(--teal-700);
    }
    .hover\:bg-rose-700:hover {
      background-color: var(--rose-700);
    }
    .hover\:bg-stone-50:hover {
      background-color: var(--stone-50);
    }
    .hover\:bg-stone-800:hover {
      background-color: var(--stone-800);
    }
    .w-full {
      width: 100%;
    }
    .w-1\/2 {
      width: 50%;
    }
    .h-4 {
      height: 1rem;
    }
    .w-4 {
      width: 1rem;
    }
    .h-48 {
      height: 12rem;
    }
    .overflow-y-auto {
      overflow-y: auto;
    }
    .border {
      border: 1px solid var(--stone-200);
    }
    .border-b {
      border-bottom: 1px solid currentColor;
    }
    .border-t-2 {
      border-top: 2px solid currentColor;
    }
    .border-dashed {
      border-style: dashed;
    }
    .border-stone-100 {
      border-color: var(--stone-100);
    }
    .border-stone-200 {
      border-color: var(--stone-200);
    }
    .border-stone-300 {
      border-color: var(--stone-300);
    }
    .rounded {
      border-radius: 0.25rem;
    }
    .rounded-md {
      border-radius: 0.375rem;
    }
    .rounded-lg {
      border-radius: 0.5rem;
    }
    .rounded-full {
      border-radius: 9999px;
    }
    .shadow-sm {
      box-shadow: 0 1px 2px rgba(15, 23, 42, 0.08);
    }
    .shadow-md {
      box-shadow: 0 4px 6px -1px rgba(15, 23, 42, 0.1), 0 2px 4px -2px rgba(15, 23, 42, 0.1);
    }
    .ring-2 {
      outline: 2px solid var(--ring-color, var(--ring-default));
      outline-offset: 2px;
    }
    .ring-teal-500 {
      --ring-color: rgba(20, 184, 166, 0.55);
    }
    .transition-all,
    .transition-colors {
      transition-duration: 150ms;
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .transition-all {
      transition-property: all;
    }
    .transition-colors {
      transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
    }
    .duration-300 {
      transition-duration: 300ms;
    }
    .ease-in-out {
      transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .list-disc {
      list-style-type: disc;
    }
    .list-inside {
      list-style-position: inside;
    }
    .status-tovisit {
      background-color: #ffffff;
    }
    .status-visited {
      background-color: #dcfce7;
      color: #166534;
    }
    .status-dropped {
      background-color: #fee2e2;
      color: #991b1b;
      text-decoration: line-through;
    }
    .recommendation-stay {
      color: #0f766e;
    }
    .recommendation-leave {
      color: #be123c;
    }
    </style>
  </head>
  <body class="text-stone-800" data-active-day-id="Tue">
    <script id="itinerary-data" type="application/json">{"runTimestamp":"2025-09-17T12:23:03.471Z","runId":"AA-v3","runNote":"Tuesday! Ann Arbor TS Locked","days":[{"dayId":"Tue","stops":[{"id":"HCGs1","name":"Hollywood Casino Greektown","type":"start","arrive":"09:00","depart":"09:00","lat":42.336873,"lon":-83.0418499},{"id":"TS","name":"The ShareHouse","type":"store","arrive":"10:09","depart":"10:39","lat":42.28746620984,"lon":-83.830718044144,"address":"5161 Jackson Rd, Ann Arbor, MI 48103","dwellMin":30,"legIn":{"fromId":"HCGs1","toId":"TS","driveMin":69.3442113611251,"distanceMi":40.45078996065631},"score":5,"tags":["must-visit","Thrift"]},{"id":"RAGS","name":"Ragstock","type":"store","arrive":"10:47","depart":"11:17","lat":42.279535758164,"lon":-83.7453166195,"address":"337 E Liberty St, Ann Arbor, MI 48104","dwellMin":30,"legIn":{"fromId":"TS","toId":"RAGS","driveMin":7.542452050594691,"distanceMi":4.399763696180236},"score":4,"tags":["Vintage"]},{"id":"TSAFS","name":"The Salvation Army Family Store & Donation Center","type":"store","arrive":"11:19","depart":"11:49","lat":42.261142020686,"lon":-83.740301350218,"address":"1621 S State St, Ann Arbor, MI 48104","dwellMin":30,"legIn":{"fromId":"RAGS","toId":"TSAFS","driveMin":2.2225867582091015,"distanceMi":1.2965089422886424},"score":3.7,"tags":["Thrift"]},{"id":"SCR","name":"SCRAP Creative Reuse","type":"store","arrive":"11:55","depart":"12:25","lat":42.252675241419,"lon":-83.673510381064,"address":"4567 Washtenaw Ave, Ann Arbor, MI 48108","dwellMin":30,"legIn":{"fromId":"TSAFS","toId":"SCR","driveMin":5.940626508554244,"distanceMi":3.4653654633233093},"score":3.8,"tags":["Thrift"]},{"id":"TTD","name":"The Thrift Depot","type":"store","arrive":"12:31","depart":"13:01","lat":42.246014266817,"lon":-83.610426982545,"address":"19 E Cross St, Ypsilanti, MI 48198","dwellMin":30,"legIn":{"fromId":"SCR","toId":"TTD","driveMin":5.58698551913752,"distanceMi":3.2590748861635532},"score":3.7,"tags":["Thrift"]},{"id":"LHAAR","name":"Lucky Haskins Antiques and Retro","type":"store","arrive":"13:01","depart":"13:31","lat":42.246015000802,"lon":-83.610324590991,"address":"27 E Cross St, Ypsilanti, MI 48198","dwellMin":30,"legIn":{"fromId":"TTD","toId":"LHAAR","driveMin":0.008978334569729655,"distanceMi":0.005237361832342299},"score":3.7,"tags":["Antique"]},{"id":"VWT9","name":"Value World Thrift","type":"store","arrive":"13:33","depart":"14:03","lat":42.245572221237,"lon":-83.582547913813,"address":"1410 E Michigan Ave, Ypsilanti, MI 48198","dwellMin":30,"legIn":{"fromId":"LHAAR","toId":"VWT9","driveMin":2.436092463679862,"distanceMi":1.4210539371465862},"score":4,"tags":["Thrift"]},{"id":"TBIN","name":"The Barn in Northville","type":"store","arrive":"14:26","depart":"14:56","lat":42.436301752318,"lon":-83.519719175565,"address":"48120 Eight Mile W, Northville, MI 48167","dwellMin":30,"legIn":{"fromId":"VWT9","toId":"TBIN","driveMin":23.251366461785032,"distanceMi":13.563297102707935},"score":3.8,"tags":["Antique"]},{"id":"TPCAA","name":"Town Peddler Craft and Antique Mall","type":"store","arrive":"15:10","depart":"15:40","lat":42.367865594867,"lon":-83.391025127892,"address":"35323 Plymouth Rd, Livonia, MI 48150","dwellMin":30,"legIn":{"fromId":"TBIN","toId":"TPCAA","driveMin":13.871211417514735,"distanceMi":8.091539993550262},"score":4,"tags":["must-visit","Antique"]},{"id":"VWT-Westland","name":"Value World Thrift","type":"store","arrive":"15:43","depart":"16:13","lat":42.343181412273,"lon":-83.388254959552,"address":"35300 Central City Pkwy, Westland, MI 48185","dwellMin":30,"legIn":{"fromId":"TPCAA","toId":"VWT-Westland","driveMin":2.9338049058073223,"distanceMi":1.7113861950542713},"score":4,"tags":["Thrift"]},{"id":"HCGe1","name":"Hollywood Casino Greektown","type":"end","arrive":"16:43","depart":"16:43","lat":42.336873,"lon":-83.0418499,"legIn":{"fromId":"VWT-Westland","toId":"HCGe1","driveMin":30.33742564206288,"distanceMi":17.696831624536678}}],"excluded":[{"id":"AAPTS","reason":"timeWindow","nearestAlternateId":"TSAFS"},{"id":"AATS","reason":"timeWindow","nearestAlternateId":"SCR"},{"id":"AAV","reason":"timeWindow","nearestAlternateId":"LHAAR"},{"id":"CAM","reason":"timeWindow","nearestAlternateId":"TS"},{"id":"CCA","reason":"timeWindow","nearestAlternateId":"SCR"},{"id":"FASV","reason":"timeWindow","nearestAlternateId":"TTD"},{"id":"FKVV","reason":"timeWindow","nearestAlternateId":"TPCAA"},{"id":"GIOSM","reason":"timeWindow","nearestAlternateId":"TSAFS"},{"id":"GSADC","reason":"timeWindow","nearestAlternateId":"VWT-Westland"},{"id":"GSADY","reason":"timeWindow","nearestAlternateId":"SCR"},{"id":"JMA","reason":"timeWindow","nearestAlternateId":"LHAAR"},{"id":"KTS","reason":"timeWindow","nearestAlternateId":"TS"},{"id":"NARS","reason":"timeWindow","nearestAlternateId":"TSAFS"},{"id":"PTS","reason":"timeWindow","nearestAlternateId":"TPCAA"},{"id":"SCA","reason":"timeWindow","nearestAlternateId":"TTD"},{"id":"TGV","reason":"timeWindow","nearestAlternateId":"RAGS"},{"id":"TSAFSCT","reason":"timeWindow","nearestAlternateId":"TPCAA"}],"metrics":{"storeCount":22,"storesVisited":10,"visitedIds":["TS","RAGS","TSAFS","SCR","TTD","LHAAR","VWT9","TBIN","TPCAA","VWT-Westland"],"totalScore":39.7,"scorePerStore":3.97,"scorePerMin":0.08565712604095842,"scorePerDriveMin":0.24284948735766798,"scorePerMile":0.4163134068988594,"totalDriveMin":163.4757414230402,"totalDwellMin":300,"slackMin":16.524258576959937,"totalDistanceMiles":95.36084916344012,"onTimeRisk":0}}]}</script>
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
      <header class="mb-6">
        <h1 class="text-3xl font-bold text-stone-900">Rust Belt Bandit Planner</h1>
        <div id="run-info" class="text-stone-600 mt-1 text-sm space-x-0">
          <span class="font-semibold">Run ID:</span>
          <span class="ml-1">AA-v3</span>
          <span class="ml-2 text-stone-500">Tuesday! Ann Arbor TS Locked</span>
        </div>
        <p class="text-xs text-stone-500 mt-1">Generated 2025-09-17T12:23:03.471Z</p>
        <p id="active-day-label" class="text-sm text-stone-600 mt-2">Day Tue</p>
      </header>
      <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <section class="lg:col-span-1 bg-white p-4 rounded-lg shadow-sm">
          <h2 class="text-xl font-semibold mb-3">Itinerary</h2>
          <div id="itinerary-list" class="space-y-2">
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="TS"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">The ShareHouse</p>
                  <p class="text-xs text-stone-500">10:09 – 10:39</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">5.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="RAGS"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Ragstock</p>
                  <p class="text-xs text-stone-500">10:47 – 11:17</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="TSAFS"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">The Salvation Army Family Store &amp; Donation Center</p>
                  <p class="text-xs text-stone-500">11:19 – 11:49</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">3.7</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="SCR"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">SCRAP Creative Reuse</p>
                  <p class="text-xs text-stone-500">11:55 – 12:25</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">3.8</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="TTD"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">The Thrift Depot</p>
                  <p class="text-xs text-stone-500">12:31 – 13:01</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">3.7</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="LHAAR"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Lucky Haskins Antiques and Retro</p>
                  <p class="text-xs text-stone-500">13:01 – 13:31</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">3.7</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="VWT9"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Value World Thrift</p>
                  <p class="text-xs text-stone-500">13:33 – 14:03</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="TBIN"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">The Barn in Northville</p>
                  <p class="text-xs text-stone-500">14:26 – 14:56</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">3.8</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="TPCAA"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Town Peddler Craft and Antique Mall</p>
                  <p class="text-xs text-stone-500">15:10 – 15:40</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.0</p>
                </div>
              </div>
            </div>
            <div
              class="p-3 rounded-md shadow-sm status-tovisit"
              data-stop-id="VWT-Westland"
              data-stop-type="store"
            >
              <div class="flex justify-between items-start">
                <div>
                  <p class="font-semibold">Value World Thrift</p>
                  <p class="text-xs text-stone-500">15:43 – 16:13</p>
                </div>
                <div class="text-right">
                  <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">4.0</p>
                </div>
              </div>
            </div>
          </div>
          <noscript>
            <div class="mt-4 space-y-3 text-sm text-stone-600">
              <div>
                <p class="font-semibold">Day Tue</p>
                <ul class="list-disc list-inside text-xs text-stone-500">
                  <li>09:00 – 09:00 · Hollywood Casino Greektown (start)</li>
                  <li>10:09 – 10:39 · The ShareHouse (store)</li>
                  <li>10:47 – 11:17 · Ragstock (store)</li>
                  <li>11:19 – 11:49 · The Salvation Army Family Store &amp; Donation Center (store)</li>
                  <li>11:55 – 12:25 · SCRAP Creative Reuse (store)</li>
                  <li>12:31 – 13:01 · The Thrift Depot (store)</li>
                  <li>13:01 – 13:31 · Lucky Haskins Antiques and Retro (store)</li>
                  <li>13:33 – 14:03 · Value World Thrift (store)</li>
                  <li>14:26 – 14:56 · The Barn in Northville (store)</li>
                  <li>15:10 – 15:40 · Town Peddler Craft and Antique Mall (store)</li>
                  <li>15:43 – 16:13 · Value World Thrift (store)</li>
                  <li>16:43 – 16:43 · Hollywood Casino Greektown (end)</li>
                </ul>
              </div>
            </div>
          </noscript>
        </section>
        <section class="lg:col-span-1 flex flex-col gap-6">
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-1">Current Stop</h2>
            <p id="current-store-name" class="text-2xl font-bold text-teal-700">Loading...</p>
            <div id="store-timeline" class="mt-4">
              <h3 class="text-sm font-medium text-stone-600 mb-2">Visit Timeline</h3>
              <div class="flex items-center justify-between text-xs text-center">
                <div class="flex-1">
                  <p id="timeline-arrive-time" class="font-semibold">--:--</p>
                  <p class="text-stone-500">Arrive</p>
                </div>
                <div class="flex-1 border-t-2 border-dashed border-stone-300 mx-2"></div>
                <div class="flex-1">
                  <p id="timeline-mqa-time" class="font-semibold">--:--</p>
                  <p class="text-stone-500">MQA Check-in</p>
                </div>
                <div class="flex-1 border-t-2 border-dashed border-stone-300 mx-2"></div>
                <div class="flex-1">
                  <p class="font-semibold">Now</p>
                  <p class="text-stone-500">Decision</p>
                </div>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm flex-grow">
            <h2 class="text-xl font-semibold mb-3">Measured Quality Assessment (MQA)</h2>
            <div id="mqa-form" class="space-y-3">
              <p class="text-sm text-stone-600">
                After 30 minutes, assess the store's quality:
              </p>
              <div id="mqa-select" class="grid grid-cols-2 gap-3"></div>
              <div class="flex gap-3 pt-3">
                <button
                  id="decision-button"
                  class="w-full bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors"
                >
                  Process MQA
                </button>
                <button
                  id="bust-button"
                  class="w-1/2 bg-rose-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-rose-700 transition-colors"
                >
                  Bust!
                </button>
              </div>
            </div>
            <div id="recommendation-display" class="mt-4 text-center"></div>
          </div>
        </section>
        <section class="lg:col-span-1 flex flex-col gap-6">
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <h2 class="text-xl font-semibold mb-3">Dashboard</h2>
            <div class="grid grid-cols-2 gap-4 text-center">
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-total-stores">0</p>
                <p class="text-sm text-stone-600">Total Stores</p>
              </div>
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-stores-visited">0</p>
                <p class="text-sm text-stone-600">Stores Visited</p>
              </div>
              <div class="bg-stone-50 p-3 rounded-md">
                <p class="text-2xl font-bold" id="dashboard-avg-jscore">0.0</p>
                <p class="text-sm text-stone-600">Avg. J-Score</p>
              </div>
              <div class="bg-teal-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-teal-800" id="dashboard-expected-quality">0.0</p>
                <p class="text-sm text-teal-700">Remaining Posterior μ</p>
              </div>
              <div class="bg-teal-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-teal-800" id="dashboard-pool-uncertainty">±0.0</p>
                <p class="text-sm text-teal-700">Remaining Uncertainty σ</p>
              </div>
              <div class="bg-blue-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-blue-800" id="dashboard-current-mean">0.0</p>
                <p class="text-sm text-blue-700">Current Posterior μ</p>
              </div>
              <div class="bg-blue-50 p-3 rounded-md">
                <p class="text-2xl font-bold text-blue-800" id="dashboard-current-uncertainty">±0.0</p>
                <p class="text-sm text-blue-700">Current Uncertainty σ</p>
              </div>
              <div class="bg-emerald-50 p-3 rounded-md col-span-2">
                <p class="text-2xl font-bold text-emerald-800" id="dashboard-current-thompson">0.0</p>
                <p class="text-sm text-emerald-700">Current Thompson Draw</p>
              </div>
              <div class="bg-teal-100 p-3 rounded-md col-span-2">
                <p class="text-2xl font-bold text-teal-900" id="dashboard-pool-thompson">0.0</p>
                <p class="text-sm text-teal-900">Remaining Thompson Draw</p>
              </div>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm flex-grow">
            <h2 class="text-xl font-semibold mb-3">Trip Log</h2>
            <div id="trip-log" class="text-sm space-y-2 overflow-y-auto h-48">
              <p class="text-stone-500">Your decisions will appear here.</p>
            </div>
          </div>
          <div class="bg-white p-4 rounded-lg shadow-sm">
            <button
              id="export-button"
              class="w-full bg-stone-700 text-white font-bold py-2 px-4 rounded-lg hover:bg-stone-800 transition-colors"
            >
              Export Trip Data
            </button>
          </div>
        </section>
      </main>
    </div>
    <script>
    (function () {
      'use strict';
    
      const SCORE_MIN = 0;
      const SCORE_MAX = 5;
      const SCORE_RANGE = SCORE_MAX - SCORE_MIN;
      const EPSILON = 1e-6;
    
      const appState = {
        itinerary: null,
        stops: [],
        currentIndex: 0,
        log: [],
        dayId: null,
        mqaMap: {
          Bust: 0.0,
          Average: 3.5,
          Good: 4.2,
          Exceptional: 5.0,
        },
        posteriorConfig: {
          priorStrength: 4,
          baseAlpha: EPSILON,
          baseBeta: EPSILON,
          credibleZ: 1.0,
          defaultScore: 3.5,
        },
        posteriorPool: {
          observedAlpha: 0,
          observedBeta: 0,
          observationCount: 0,
          totalObservedQuality: 0,
          lastObservation: null,
          lastThompson: null,
        },
      };
    
      let spareNormal = null;
    
      document.addEventListener('DOMContentLoaded', init);
    
      function init() {
        const dataElement = document.getElementById('itinerary-data');
        if (!dataElement) {
          console.error('Itinerary data script tag not found.');
          return;
        }
    
        try {
          appState.itinerary = JSON.parse(dataElement.textContent || '{}');
        } catch (err) {
          console.error('Failed to parse itinerary JSON.', err);
          return;
        }
    
        const days = Array.isArray(appState.itinerary?.days)
          ? appState.itinerary.days
          : [];
        const activeDayId = document.body?.dataset?.activeDayId;
        const day =
          (activeDayId && days.find((d) => d?.dayId === activeDayId)) ||
          days.find((d) => Array.isArray(d?.stops) && d.stops.length > 0) ||
          days.find(() => true);
        if (!day) {
          console.error('Unable to determine active day for itinerary.');
          return;
        }
    
        appState.dayId = day.dayId ?? null;
        if (document.body && appState.dayId) {
          document.body.dataset.activeDayId = appState.dayId;
        }
    
        const dayLabel = document.getElementById('active-day-label');
        if (dayLabel && day.dayId) {
          dayLabel.textContent = `Day ${day.dayId}`;
        }
    
        const stops = Array.isArray(day.stops) ? day.stops : [];
        appState.stops = stops
          .filter((stop) => stop.type === 'store')
          .map((stop) => ({
            ...stop,
            status: 'tovisit',
            posterior: createPosterior(stop.score),
          }));
    
        appState.currentIndex = appState.stops.findIndex((s) => s.status === 'tovisit');
        if (appState.currentIndex === -1) {
          appState.currentIndex = appState.stops.length;
        }
    
        const runInfo = document.getElementById('run-info');
        if (runInfo && appState.itinerary) {
          const existing = runInfo.textContent?.trim();
          if (!existing) {
            const runId = appState.itinerary.runId ?? 'Unknown Run';
            const runNote = appState.itinerary.runNote ? ` - ${appState.itinerary.runNote}` : '';
            runInfo.textContent = `Run ID: ${runId}${runNote}`;
          }
        }
    
        setupMQAOptions();
        renderAll();
        addEventListeners();
      }
    
      function setupMQAOptions() {
        const container = document.getElementById('mqa-select');
        if (!container) return;
        container.innerHTML = '';
        Object.entries(appState.mqaMap).forEach(([key, value]) => {
          const div = document.createElement('div');
          div.className = 'flex items-center p-3 rounded-lg border border-stone-200 hover:bg-stone-50';
          div.innerHTML = `
            <input id="mqa-${key.toLowerCase()}" type="radio" name="mqa" value="${key}" class="h-4 w-4 text-teal-600 border-stone-300 focus:ring-teal-500">
            <label for="mqa-${key.toLowerCase()}" class="ml-3 block text-sm font-medium text-stone-700">
              ${key} <span class="text-xs text-stone-500">(${value.toFixed(1)})</span>
            </label>
          `;
          container.appendChild(div);
        });
      }
    
      function renderAll() {
        const currentStop = appState.stops[appState.currentIndex];
        const metrics = calculateMetrics(currentStop?.id);
        renderDashboard(metrics);
        renderItineraryList(currentStop);
        renderCurrentStore(currentStop);
        renderTripLog();
      }
    
      function calculateMetrics(excludeId) {
        const totalStores = appState.stops.length;
        const visitedStores = appState.stops.filter((s) => s.status === 'visited').length;
        const overallAvgScore =
          totalStores > 0
            ? (
                appState.stops.reduce(
                  (sum, s) => sum + (typeof s.score === 'number' ? s.score : appState.posteriorConfig.defaultScore),
                  0,
                ) / totalStores
              ).toFixed(1)
            : '0.0';
    
        const poolPosterior = computeRemainingPoolPosterior(excludeId);
        const currentStop = appState.stops[appState.currentIndex];
    
        return {
          totalStores,
          visitedStores,
          overallAvgScore,
          poolPosterior,
          currentPosterior: currentStop ? currentStop.posterior : null,
          expectedRemQuality: poolPosterior ? poolPosterior.mean.toFixed(2) : '0.0',
        };
      }
    
      function renderDashboard(metrics) {
        const {
          totalStores,
          visitedStores,
          overallAvgScore,
          poolPosterior,
          currentPosterior,
        } = metrics;
    
        setText('dashboard-total-stores', totalStores);
        setText('dashboard-stores-visited', visitedStores);
        setText('dashboard-avg-jscore', overallAvgScore);
        setText(
          'dashboard-expected-quality',
          poolPosterior ? poolPosterior.mean.toFixed(2) : '--',
        );
        setText(
          'dashboard-pool-uncertainty',
          poolPosterior ? `±${poolPosterior.std.toFixed(2)}` : '±--',
        );
        setText(
          'dashboard-current-mean',
          currentPosterior ? currentPosterior.mean.toFixed(2) : '--',
        );
        setText(
          'dashboard-current-uncertainty',
          currentPosterior ? `±${currentPosterior.std.toFixed(2)}` : '±--',
        );
        setText(
          'dashboard-current-thompson',
          currentPosterior?.lastThompson != null
            ? currentPosterior.lastThompson.toFixed(2)
            : '--',
        );
        setText(
          'dashboard-pool-thompson',
          poolPosterior?.lastThompson != null ? poolPosterior.lastThompson.toFixed(2) : '--',
        );
      }
    
      function renderItineraryList(currentStop) {
        const container = document.getElementById('itinerary-list');
        if (!container) return;
        container.innerHTML = '';
        appState.stops.forEach((stop, index) => {
          const isCurrent = currentStop && stop.id === currentStop.id && stop.status === 'tovisit';
          const div = document.createElement('div');
          div.id = `row-${stop.id}`;
          div.className = `p-3 rounded-md transition-all duration-300 ease-in-out status-${stop.status} ${
            isCurrent ? 'ring-2 ring-teal-500 shadow-md' : 'shadow-sm'
          }`;
          const posteriorMean = stop.posterior ? stop.posterior.mean.toFixed(2) : formatScore(stop.score);
          const posteriorStd = stop.posterior ? stop.posterior.std.toFixed(2) : '0.00';
          const statusLabel =
            stop.status === 'visited'
              ? `Visited – ${stop.mqa ?? 'n/a'}`
              : stop.status === 'dropped'
              ? 'Dropped'
              : 'To Visit';
          div.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <p class="font-semibold">${stop.name}</p>
                <p class="text-xs text-stone-500">${statusLabel}</p>
              </div>
              <div class="text-right">
                <p class="font-mono text-sm bg-stone-200 text-stone-700 px-2 py-1 rounded">${posteriorMean}</p>
                <p class="text-xs text-stone-500">±${posteriorStd}</p>
              </div>
            </div>
          `;
          container.appendChild(div);
        });
      }
    
      function renderCurrentStore(currentStop) {
        const nameEl = document.getElementById('current-store-name');
        const form = document.getElementById('mqa-form');
        if (!nameEl || !form) return;
    
        if (!currentStop || currentStop.status !== 'tovisit') {
          nameEl.textContent = 'Trip Complete!';
          form.style.display = 'none';
          setText('timeline-arrive-time', '--:--');
          setText('timeline-mqa-time', '--:--');
          return;
        }
    
        form.style.display = 'block';
        nameEl.textContent = currentStop.name;
    
        const [arriveH, arriveM] = currentStop.arrive.split(':').map(Number);
        const mqaTime = new Date();
        mqaTime.setHours(arriveH, arriveM + 30, 0, 0);
        const mqaH = String(mqaTime.getHours()).padStart(2, '0');
        const mqaM = String(mqaTime.getMinutes()).padStart(2, '0');
    
        setText('timeline-arrive-time', currentStop.arrive);
        setText('timeline-mqa-time', `${mqaH}:${mqaM}`);
      }
    
      function renderTripLog() {
        const container = document.getElementById('trip-log');
        if (!container) return;
    
        if (appState.log.length === 0) {
          container.innerHTML = '<p class="text-stone-500">Your decisions will appear here.</p>';
          return;
        }
    
        container.innerHTML = '';
        appState.log.forEach((entry) => {
          const div = document.createElement('div');
          div.className = 'p-2 border-b border-stone-100';
          const posterior = entry.posterior;
          const pool = entry.pool;
          const mqaValueText = entry.mqaValue != null ? ` (${entry.mqaValue.toFixed(1)})` : '';
          const zScoreText = entry.zScore != null ? ` | z=${entry.zScore.toFixed(2)}` : '';
          div.innerHTML = `
            <p class="font-medium">${entry.name}</p>
            <p class="text-stone-600">MQA: <span class="font-semibold">${entry.mqa}</span>${mqaValueText} → Decision: <span class="font-semibold">${entry.decision}</span></p>
            <p class="text-xs text-stone-500">Posterior μ=${posterior.mean.toFixed(2)} σ=${posterior.std.toFixed(2)} | Thompson=${
              posterior.lastThompson != null ? posterior.lastThompson.toFixed(2) : '--'
            } | Pool μ=${pool.mean.toFixed(2)} σ=${pool.std.toFixed(2)}${
            pool.lastThompson != null ? ` | Pool Thompson=${pool.lastThompson.toFixed(2)}` : ''
          }${zScoreText ? zScoreText : ''}</p>
          `;
          container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
      }
    
      function processDecision(mqaKey) {
        const currentStop = appState.stops[appState.currentIndex];
        if (!currentStop) return;
    
        const mqaValue = appState.mqaMap[mqaKey];
        if (typeof mqaValue !== 'number') {
          console.warn('Unknown MQA key selected:', mqaKey);
          return;
        }
    
        updateStopPosterior(currentStop, mqaValue);
        updatePoolObservation(mqaValue);
    
        const poolPosterior = computeRemainingPoolPosterior(currentStop.id);
        const currentSample = drawThompsonSample(currentStop.posterior.alpha, currentStop.posterior.beta);
        const poolSample = drawThompsonSample(poolPosterior.alpha, poolPosterior.beta);
        const decisionMeta = getBayesianRecommendation(
          currentStop.posterior,
          poolPosterior,
          mqaKey,
          currentSample,
          poolSample,
        );
        const recommendation = decisionMeta.decision;
    
        currentStop.posterior.lastThompson = currentSample;
        appState.posteriorPool.lastThompson = poolSample;
        poolPosterior.lastThompson = poolSample;
    
        updateRecommendationDisplay(recommendation, decisionMeta, currentStop.posterior, poolPosterior);
    
        currentStop.mqa = mqaKey;
        currentStop.mqaValue = mqaValue;
        currentStop.decision = recommendation;
        currentStop.decisionReason = decisionMeta.reason;
        currentStop.status = 'visited';
        currentStop.posteriorSummary = serializePosterior(currentStop.posterior);
        currentStop.posteriorSummary.diff = decisionMeta.diff;
        currentStop.posteriorSummary.zScore = decisionMeta.zScore;
    
        appState.log.push({
          name: currentStop.name,
          mqa: mqaKey,
          mqaValue,
          decision: recommendation,
          decisionReason: decisionMeta.reason,
          diff: decisionMeta.diff,
          zScore: decisionMeta.zScore,
          posterior: serializePosterior(currentStop.posterior),
          pool: serializePool(poolPosterior),
          timestamp: new Date().toISOString(),
        });
    
        renderAll();
    
        if (recommendation === 'Stay' && mqaKey === 'Exceptional') {
          handleOverrun();
        } else {
          advanceToNextStore();
        }
      }
    
      function updateRecommendationDisplay(recommendation, meta, currentPosterior, poolPosterior) {
        const display = document.getElementById('recommendation-display');
        if (!display) return;
        const diffText = meta.diff != null ? `Δμ=${meta.diff.toFixed(2)}` : '';
        const zText = meta.zScore != null && Number.isFinite(meta.zScore) ? `z=${meta.zScore.toFixed(2)}` : '';
        const reason = humanizeReason(meta.reason);
        const currentSummary = currentPosterior
          ? `Current μ=${currentPosterior.mean.toFixed(2)} σ=${currentPosterior.std.toFixed(2)} Thompson=${
              currentPosterior.lastThompson != null ? currentPosterior.lastThompson.toFixed(2) : '--'
            }`
          : '';
        const poolSummary = poolPosterior
          ? `Pool μ=${poolPosterior.mean.toFixed(2)} σ=${poolPosterior.std.toFixed(2)} Thompson=${
              poolPosterior.lastThompson != null ? poolPosterior.lastThompson.toFixed(2) : '--'
            }`
          : '';
    
        const metaLine = [reason, diffText, zText].filter(Boolean).join(' · ');
        const summaryLine = [currentSummary, poolSummary].filter(Boolean).join(' | ');
    
        display.innerHTML = `
          <p class="text-lg font-medium">Recommendation:</p>
          <p class="text-3xl font-bold recommendation-${recommendation.toLowerCase()}">${recommendation.toUpperCase()}</p>
          <p class="text-sm text-stone-600">${metaLine}</p>
          <p class="text-xs text-stone-500">${summaryLine}</p>
        `;
      }
    
      function handleOverrun() {
        const remainingStops = appState.stops.filter((s) => s.status === 'tovisit');
        if (remainingStops.length === 0) {
          advanceToNextStore();
          return;
        }
    
        const lowestScoringStop = remainingStops.reduce((min, stop) =>
          stop.posterior.mean < min.posterior.mean ? stop : min,
        );
    
        setTimeout(() => {
          const confirmed = window.confirm(
            `To extend your stay, drop the lowest-rated remaining store:\n\n${lowestScoringStop.name} (Posterior μ: ${lowestScoringStop.posterior.mean.toFixed(
              2,
            )})\n\nDrop this store?`,
          );
    
          if (confirmed) {
            const stopToDrop = appState.stops.find((s) => s.id === lowestScoringStop.id);
            if (stopToDrop) {
              stopToDrop.status = 'dropped';
              appState.log.push({
                name: stopToDrop.name,
                mqa: 'N/A',
                mqaValue: null,
                decision: 'Dropped',
                decisionReason: 'overrun-drop-lowest',
                diff: null,
                zScore: null,
                posterior: serializePosterior(stopToDrop.posterior),
                pool: serializePool(computeRemainingPoolPosterior()),
                timestamp: new Date().toISOString(),
              });
            }
          }
          advanceToNextStore();
        }, 500);
      }
    
      function advanceToNextStore() {
        let nextIndex = appState.currentIndex + 1;
        while (nextIndex < appState.stops.length && appState.stops[nextIndex].status !== 'tovisit') {
          nextIndex += 1;
        }
        appState.currentIndex = nextIndex;
    
        const selectedRadio = document.querySelector('input[name="mqa"]:checked');
        if (selectedRadio) selectedRadio.checked = false;
        const display = document.getElementById('recommendation-display');
        if (display) display.innerHTML = '';
    
        renderAll();
      }
    
      function addEventListeners() {
        const decisionButton = document.getElementById('decision-button');
        if (decisionButton) {
          decisionButton.addEventListener('click', () => {
            const selectedMQA = document.querySelector('input[name="mqa"]:checked');
            if (!selectedMQA) {
              window.alert('Please select a Measured Quality Assessment (MQA).');
              return;
            }
            processDecision(selectedMQA.value);
          });
        }
    
        const bustButton = document.getElementById('bust-button');
        if (bustButton) {
          bustButton.addEventListener('click', () => {
            processDecision('Bust');
          });
        }
    
        const exportButton = document.getElementById('export-button');
        if (exportButton) {
          exportButton.addEventListener('click', () => {
            const poolSnapshot = computeRemainingPoolPosterior();
            const exportData = {
              runInfo: appState.itinerary,
              activeDayId: appState.dayId,
              finalStopsState: appState.stops.map((stop) => ({
                id: stop.id,
                name: stop.name,
                type: stop.type,
                arrive: stop.arrive,
                depart: stop.depart,
                score: stop.score,
                status: stop.status,
                mqa: stop.mqa ?? null,
                mqaValue: stop.mqaValue ?? null,
                decision: stop.decision ?? null,
                decisionReason: stop.decisionReason ?? null,
                posterior: serializePosterior(stop.posterior),
              })),
              tripLog: appState.log,
              posteriorPool: {
                ...serializePool(poolSnapshot),
                observedAlpha: appState.posteriorPool.observedAlpha,
                observedBeta: appState.posteriorPool.observedBeta,
                observationCount: appState.posteriorPool.observationCount,
                totalObservedQuality: appState.posteriorPool.totalObservedQuality,
              },
              posteriorConfig: appState.posteriorConfig,
            };
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const a = document.createElement('a');
            a.href = url;
            const runId = appState.itinerary?.runId ?? 'trip';
            a.download = `rust-belt-trip-${runId}-results.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          });
        }
      }
    
      function getBayesianRecommendation(currentPosterior, poolPosterior, mqaKey, currentSample, poolSample) {
        if (mqaKey === 'Bust') {
          return { decision: 'Leave', reason: 'mqa-bust', diff: -Infinity, zScore: null, currentSample, poolSample };
        }
        if (!currentPosterior) {
          return { decision: 'Leave', reason: 'no-current-posterior', diff: null, zScore: null, currentSample, poolSample };
        }
        if (!poolPosterior || poolPosterior.count === 0) {
          return { decision: 'Stay', reason: 'no-remaining-stops', diff: currentPosterior.mean, zScore: null, currentSample, poolSample };
        }
    
        const diff = currentPosterior.mean - poolPosterior.mean;
        const combinedStd = Math.sqrt(
          currentPosterior.std * currentPosterior.std + poolPosterior.std * poolPosterior.std,
        );
        const zScore = combinedStd > 0 ? diff / combinedStd : diff >= 0 ? Number.POSITIVE_INFINITY : Number.NEGATIVE_INFINITY;
    
        if (currentPosterior.lower >= poolPosterior.upper) {
          return { decision: 'Stay', reason: 'posterior-dominates', diff, zScore, currentSample, poolSample };
        }
        if (poolPosterior.lower >= currentPosterior.upper) {
          return { decision: 'Leave', reason: 'pool-dominates', diff, zScore, currentSample, poolSample };
        }
        if (currentSample >= poolSample) {
          return { decision: 'Stay', reason: 'thompson-preference', diff, zScore, currentSample, poolSample };
        }
        if (diff >= 0 && zScore >= -0.25) {
          return { decision: 'Stay', reason: 'expected-value-edge', diff, zScore, currentSample, poolSample };
        }
        return { decision: 'Leave', reason: 'expected-value-deficit', diff, zScore, currentSample, poolSample };
      }
    
      function computeRemainingPoolPosterior(excludeId) {
        const remainingStops = appState.stops.filter(
          (s) => s.status === 'tovisit' && (!excludeId || s.id !== excludeId),
        );
    
        let pseudoAlpha = 0;
        let pseudoBeta = 0;
        remainingStops.forEach((stop) => {
          const priorNorm = stop.posterior?.priorNormalized ?? normalizeScore(stop.score);
          const pseudo = stop.posterior?.pseudo ?? appState.posteriorConfig.priorStrength;
          pseudoAlpha += priorNorm * pseudo;
          pseudoBeta += (1 - priorNorm) * pseudo;
        });
    
        const alpha = appState.posteriorConfig.baseAlpha + pseudoAlpha + appState.posteriorPool.observedAlpha;
        const beta = appState.posteriorConfig.baseBeta + pseudoBeta + appState.posteriorPool.observedBeta;
        const stats = computeBetaStats(alpha, beta);
        return {
          ...stats,
          count: remainingStops.length,
          pseudoAlpha,
          pseudoBeta,
          observationCount: appState.posteriorPool.observationCount,
          totalObservedQuality: appState.posteriorPool.totalObservedQuality,
          lastThompson: appState.posteriorPool.lastThompson,
        };
      }
    
      function createPosterior(baseScore) {
        const normalized = normalizeScore(baseScore);
        const pseudo = appState.posteriorConfig.priorStrength;
        const posterior = {
          alpha: appState.posteriorConfig.baseAlpha + normalized * pseudo,
          beta: appState.posteriorConfig.baseBeta + (1 - normalized) * pseudo,
          priorNormalized: normalized,
          pseudo,
          observationCount: 0,
          totalQuality: 0,
          lastObservation: null,
          lastThompson: null,
        };
        return recomputePosteriorStats(posterior);
      }
    
      function updateStopPosterior(stop, mqaValue) {
        const normalized = normalizeScore(mqaValue);
        stop.posterior.alpha += normalized;
        stop.posterior.beta += 1 - normalized;
        stop.posterior.observationCount = (stop.posterior.observationCount ?? 0) + 1;
        stop.posterior.totalQuality = (stop.posterior.totalQuality ?? 0) + mqaValue;
        stop.posterior.lastObservation = mqaValue;
        recomputePosteriorStats(stop.posterior);
      }
    
      function updatePoolObservation(mqaValue) {
        const normalized = normalizeScore(mqaValue);
        appState.posteriorPool.observedAlpha += normalized;
        appState.posteriorPool.observedBeta += 1 - normalized;
        appState.posteriorPool.observationCount += 1;
        appState.posteriorPool.totalObservedQuality += mqaValue;
        appState.posteriorPool.lastObservation = mqaValue;
      }
    
      function recomputePosteriorStats(posterior) {
        posterior.alpha = Math.max(posterior.alpha, EPSILON);
        posterior.beta = Math.max(posterior.beta, EPSILON);
        const total = posterior.alpha + posterior.beta;
        const meanNormalized = posterior.alpha / total;
        const varianceNormalized = (posterior.alpha * posterior.beta) / ((total + 1) * total * total);
        const stdScore = Math.sqrt(Math.max(varianceNormalized, 0)) * SCORE_RANGE;
        posterior.meanNormalized = meanNormalized;
        posterior.mean = denormalizeScore(meanNormalized);
        posterior.std = stdScore;
        posterior.lower = clamp(
          posterior.mean - appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        posterior.upper = clamp(
          posterior.mean + appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        posterior.variance = stdScore * stdScore;
        return posterior;
      }
    
      function computeBetaStats(alpha, beta) {
        const safeAlpha = Math.max(alpha, EPSILON);
        const safeBeta = Math.max(beta, EPSILON);
        const total = safeAlpha + safeBeta;
        const meanNormalized = safeAlpha / total;
        const varianceNormalized = (safeAlpha * safeBeta) / ((total + 1) * total * total);
        const stdScore = Math.sqrt(Math.max(varianceNormalized, 0)) * SCORE_RANGE;
        const meanScore = denormalizeScore(meanNormalized);
        const lower = clamp(
          meanScore - appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        const upper = clamp(
          meanScore + appState.posteriorConfig.credibleZ * stdScore,
          SCORE_MIN,
          SCORE_MAX,
        );
        return {
          alpha: safeAlpha,
          beta: safeBeta,
          meanNormalized,
          mean: meanScore,
          std: stdScore,
          variance: stdScore * stdScore,
          lower,
          upper,
        };
      }
    
      function serializePosterior(posterior) {
        return {
          alpha: posterior.alpha,
          beta: posterior.beta,
          mean: posterior.mean,
          meanNormalized: posterior.meanNormalized,
          std: posterior.std,
          variance: posterior.variance,
          lower: posterior.lower,
          upper: posterior.upper,
          observationCount: posterior.observationCount ?? 0,
          totalQuality: posterior.totalQuality ?? 0,
          lastObservation: posterior.lastObservation ?? null,
          lastThompson: posterior.lastThompson ?? null,
          priorNormalized: posterior.priorNormalized ?? null,
          pseudo: posterior.pseudo ?? appState.posteriorConfig.priorStrength,
        };
      }
    
      function serializePool(poolPosterior) {
        return {
          alpha: poolPosterior.alpha,
          beta: poolPosterior.beta,
          mean: poolPosterior.mean,
          meanNormalized: poolPosterior.meanNormalized,
          std: poolPosterior.std,
          variance: poolPosterior.variance,
          lower: poolPosterior.lower,
          upper: poolPosterior.upper,
          count: poolPosterior.count,
          pseudoAlpha: poolPosterior.pseudoAlpha,
          pseudoBeta: poolPosterior.pseudoBeta,
          observationCount: poolPosterior.observationCount,
          totalObservedQuality: poolPosterior.totalObservedQuality,
          lastThompson: poolPosterior.lastThompson ?? null,
        };
      }
    
      function setText(id, value) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = value;
      }
    
      function normalizeScore(value) {
        const safeValue = typeof value === 'number' ? value : appState.posteriorConfig.defaultScore;
        return clamp((safeValue - SCORE_MIN) / SCORE_RANGE, 0, 1);
      }
    
      function denormalizeScore(normalized) {
        return SCORE_MIN + clamp(normalized, 0, 1) * SCORE_RANGE;
      }
    
      function formatScore(value) {
        if (typeof value !== 'number') return '0.0';
        return value.toFixed(1);
      }
    
      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }
    
      function drawThompsonSample(alpha, beta) {
        const sample = sampleBeta(alpha, beta);
        return denormalizeScore(sample);
      }
    
      function sampleBeta(alpha, beta) {
        const x = sampleGamma(alpha);
        const y = sampleGamma(beta);
        if (x + y === 0) return 0.5;
        return x / (x + y);
      }
    
      function sampleGamma(shape) {
        const safeShape = Math.max(shape, EPSILON);
        if (safeShape < 1) {
          const u = Math.random();
          return sampleGamma(safeShape + 1) * Math.pow(u, 1 / safeShape);
        }
        const d = safeShape - 1 / 3;
        const c = 1 / Math.sqrt(9 * d);
        while (true) {
          let x;
          let v;
          do {
            x = sampleStandardNormal();
            v = 1 + c * x;
          } while (v <= 0);
          v = v * v * v;
          const u = Math.random();
          if (u < 1 - 0.0331 * x * x * x * x) return d * v;
          if (Math.log(u) < 0.5 * x * x + d * (1 - v + Math.log(v))) return d * v;
        }
      }
    
      function sampleStandardNormal() {
        if (spareNormal != null) {
          const value = spareNormal;
          spareNormal = null;
          return value;
        }
        let u = 0;
        let v = 0;
        while (u === 0) u = Math.random();
        while (v === 0) v = Math.random();
        const mag = Math.sqrt(-2.0 * Math.log(u));
        const z0 = mag * Math.cos(2 * Math.PI * v);
        const z1 = mag * Math.sin(2 * Math.PI * v);
        spareNormal = z1;
        return z0;
      }
    
      function humanizeReason(reason) {
        if (!reason) return '';
        const text = reason
          .replace(/[-_]/g, ' ')
          .replace(/\b([a-z])/g, (m) => m.toUpperCase());
        return text.replace(/\bMqa\b/g, 'MQA');
      }
    })();
    </script>
  </body>
</html>
